/*1347295033,173213213*/

if (window.CavalryLogger) { CavalryLogger.start_js(["jSkqX"]); }

__d("AjaxRequest",["ErrorUtils","Keys","URI","UserAgent","XHR","copyProperties"],function(a,b,c,d,e,f){var g=b('ErrorUtils'),h=b('Keys'),i=b('URI'),j=b('UserAgent'),k=b('XHR'),l=b('copyProperties');function m(q,r,s){this.xhr=k.create();if(!(r instanceof i))r=new i(r);if(s&&q=='GET'){r.setQueryData(s);}else this._params=s;this.method=q;this.uri=r;this.xhr.open(q,r);}var n=window.XMLHttpRequest&&('withCredentials' in new XMLHttpRequest());m.supportsCORS=function(){return n;};m.ERROR='ar:error';m.TIMEOUT='ar:timeout';m.PROXY_ERROR='ar:proxy error';m.TRANSPORT_ERROR='ar:transport error';m.SERVER_ERROR='ar:http error';m.PARSE_ERROR='ar:parse error';m._inflight=[];function o(){var q=m._inflight;m._inflight=[];q.forEach(function(r){r.abort();});}function p(q){q.onJSON=q.onError=q.onSuccess=null;clearTimeout(q._timer);if(q.xhr&&q.xhr.readyState<4){q.xhr.abort();q.xhr=null;}m._inflight=m._inflight.filter(function(r){return r&&r!=q&&r.xhr&&r.xhr.readyState<4;});}l(m.prototype,{timeout:60000,prelude:/^for \(;;\);/,status:null,_eol:-1,_call:function(q){if(this[q])this[q](this);},_parseStatus:function(){var q;try{this.status=this.xhr.status;q=this.xhr.statusText;}catch(r){if(this.xhr.readyState>=4){this.errorType=m.TRANSPORT_ERROR;this.errorText=r.message;}return;}if(this.status===0&&!(/^(file|ftp)/.test(this.uri))){this.errorType=m.TRANSPORT_ERROR;}else if(this.status>=100&&this.status<200){this.errorType=m.PROXY_ERROR;}else if(this.status>=200&&this.status<300){return;}else if(this.status>=300&&this.status<400){this.errorType=m.PROXY_ERROR;}else if(this.status>=400&&this.status<500){this.errorType=m.SERVER_ERROR;}else if(this.status>=500&&this.status<600){this.errorType=m.PROXY_ERROR;}else if(this.status==1223){return;}else if(this.status>=12001&&this.status<=12156){this.errorType=m.TRANSPORT_ERROR;}else{q='unrecognized status code: '+this.status;this.errorType=m.ERROR;}if(!this.errorText)this.errorText=q;},_parseResponse:function(){var q,r=this.xhr.readyState;try{q=this.xhr.responseText||'';}catch(s){if(r>=4){this.errorType=m.ERROR;this.errorText='responseText not available - '+s.message;}return;}while(this.xhr){var t=this._eol+1,u=q.indexOf('\n',t);if(u<0&&r==4)u=q.length;if(u<=this._eol)break;var v=q.substr(t,u-t).replace(/^\s*|\s*$/g,'');if(t===0&&this.prelude)if(this.prelude.test(v))v=v.replace(this.prelude,'');this._eol=u;if(v){try{this.json=JSON.parse(v);}catch(s){var w=(/(<body[\S\s]+?<\/body>)/i).test(q)&&RegExp.$1,x={message:s.message,'char':t,excerpt:((t===0&&w)||v).substr(512)};this.errorType=m.PARSE_ERROR;this.errorText='parse error - '+JSON.stringify(x);return;}g.applyWithGuard(this._call,this,['onJSON']);}}},_onReadyState:function(){var q=this.xhr&&this.xhr.readyState||0;if(this.status==null&&q>=2)this._parseStatus();if(this.status!=null&&q>=3&&!this.errorType)this._parseResponse();if(this.errorType||q==4){this._time=Date.now()-this._sentAt;this._call(!this.errorType?'onSuccess':'onError');p(this);}},send:function(q){this.xhr.onreadystatechange=function(){g.applyWithGuard(this._onReadyState,this,arguments);}.bind(this);var r=this.timeout;if(r)this._timer=setTimeout((function(){this.errorType=m.TIMEOUT;this.errorText='timeout';this._time=Date.now()-this._sentAt;this._call('onError');p(this);}).bind(this),r,false);m._inflight.push(this);if(this.method=='POST')this.xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');this._sentAt=Date.now();this.xhr.send(q?i.implodeQuery(q):'');},abort:function(){p(this);},toString:function(){var q='[AjaxRequest readyState='+this.xhr.readyState;if(this.errorType)q+=' errorType='+this.errorType+' ('+this.errorText+')';return q+']';},toJSON:function(){var q={json:this.json,status:this.status,errorType:this.errorType,errorText:this.errorText,time:this._time};if(this.errorType)q.uri=this.uri;for(var r in q)if(q[r]==null)delete q[r];return q;}});if(window.addEventListener&&j.firefox())window.addEventListener('keydown',function(event){if(event.keyCode===h.ESC)event.prevent();},false);if(window.attachEvent)window.attachEvent('onunload',o);e.exports=m;});
__d("ChatConfig",["copyProperties","ChatConfigInitialData"],function(a,b,c,d,e,f){var g=c('ChatConfigInitialData'),h=b('copyProperties'),i={},j={get:function(k,l){return k in i?i[k]:l;},set:function(k){if(arguments.length>1){var l={};l[k]=arguments[1];k=l;}h(i,k);},getDebugInfo:function(){return i;}};j.set(g);e.exports=j;});
__d("ChannelConstants",[],function(a,b,c,d,e,f){var g='channel/',h={ON_SHUTDOWN:g+'shutdown',ON_INVALID_HISTORY:g+'invalid_history',ON_CONFIG:g+'config',ON_ENTER_STATE:g+'enter_state',ON_EXIT_STATE:g+'exit_state',OK:'ok',ERROR:'error',ERROR_MAX:'error_max',ERROR_MISSING:'error_missing',ERROR_MSG_TYPE:'error_msg_type',ERROR_SHUTDOWN:'error_shutdown',ERROR_STALE:'error_stale',SYS_OWNER:'sys_owner',SYS_NONOWNER:'sys_nonowner',SYS_ONLINE:'sys_online',SYS_OFFLINE:'sys_offline',SYS_TIMETRAVEL:'sys_timetravel',HINT_AUTH:'shutdown auth',HINT_CONN:'shutdown conn',HINT_DISABLED:'shutdown disabled',HINT_INVALID_STATE:'shutdown invalid state',HINT_MAINT:'shutdown maint',HINT_UNSUPPORTED:'shutdown unsupported',reason_Unknown:0,reason_AsyncError:1,reason_TooLong:2,reason_Refresh:3,reason_RefreshDelay:4,reason_UIRestart:5,reason_NeedSeq:6,reason_PrevFailed:7,reason_IFrameLoadGiveUp:8,reason_IFrameLoadRetry:9,reason_IFrameLoadRetryWorked:10,reason_PageTransitionRetry:11,reason_IFrameLoadMaxSubdomain:12,reason_NoChannelInfo:13,reason_NoChannelHost:14,getArbiterType:function(i){return g+'message:'+i;}};e.exports=h;});
__d("ChannelSubdomain",["Cookie","JSLogger","UserAgent"],function(a,b,c,d,e,f){var g=b('Cookie'),h=b('JSLogger'),i=b('UserAgent'),j=h.create('channel'),k=7,l=null;function m(p){var q=null,r=n(),s,t=i.firefox()?Math.floor(Math.random()*32):0;for(var u=0;u<32;u++){s=(u+t)%32;if(!(r&(1<<s)))break;}p--;if(s<Math.min(32,k*p)){l=s;q=l%k;g.set('sub',r|(1<<l));}else{l=-1;q=null;j.error('subdomain_overflow',{slot:l,max:p});}return q;}function n(){var p=g.get('sub')||0;p=parseInt(p,10);return isNaN(p)?0:p;}function o(){if(l!==null&&l>=0){var p=n()&~(1<<l);if(p){g.set('sub',p);}else g.clear('sub');}}e.exports={allocate:m,clear:o};});
__d("ChannelTransport",["copyProperties","bind","AjaxRequest","URI","JSLogger","DocRPC","ChannelConstants"],function(a,b,c,d,e,f){var g=b('copyProperties'),h=b('bind'),i=b('AjaxRequest'),j=b('URI'),k=b('JSLogger'),l=b('DocRPC'),m=b('ChannelConstants'),n=k.create('channel');function o(){return (1048576*Math.random()|0).toString(36);}function p(x,y){var z=x.subdomain;z=z===null?'':(z+'-');var aa=new j(y).setDomain(z+x.host+'.facebook.com').setPort(x.port).setSecure(j().isSecure());return aa;}function q(x){var y={partition:x.partition,cb:o()},z=p(x,'/p').setQueryData(y);n.log('start_p',{uri:z.toString()});var aa=new i('GET',z);if(i.supportsCORS())aa.xhr.withCredentials=true;var ba=function(ca){n.log('finish_p',{xhr:ca.toJSON?ca.toJSON():ca});};aa.timeout=x.P_TIMEOUT;aa.onError=aa.onSuccess=ba;aa.send();}function r(x,y,z){var aa=new Image(),ba=0,ca=function(fa){aa.abort();return fa?y():z();};aa.onload=function(){n.log('ping_ok',{duration:Date.now()-ba});ca(true);};aa.onerror=function(){q(x);ca(false);};var da=setTimeout(aa.onerror,10000,false);aa.abort=function(){if(da){clearTimeout(da);da=null;}aa.onload=aa.onerror=null;};var ea={partition:x.partition,cb:o()};ba=Date.now();aa.src=p(x,'/ping').setQueryData(ea);return aa;}function s(x,y,z,aa){var ba=new Date(),ca=(ba-x.userActive)/1000|0;if(ca<0)n.warn('idle_regression',{idleTime:ca,now:ba.getTime(),userActive:x.userActive});var da={channel:x.user_channel,seq:x.seq,partition:x.partition,clientid:x.sessionID,cb:o(),idle:ca};if(ca<60)da.state='active';if(x.streamingCapable){da.mode='stream';da.format='json';}if(x.profile)da.profile=x.profile;var ea=p(x,'/pull').setQueryData(da),fa=new i('GET',ea);if(i.supportsCORS())fa.xhr.withCredentials=true;fa.timeout=x.streamingCapable?x.STREAMING_TIMEOUT:x.LONGPOLL_TIMEOUT;fa.onJSON=y;fa.onSuccess=z;fa.onError=function(){var ga=(this.status==12002&&this._time>=x.MIN_12002_TIMEOUT)||(this.status==504&&this._time>=x.MIN_504_TIMEOUT),ha=ga?z:aa;return ha&&ha.apply(this,arguments);};fa.send();x.inStreaming=x.streamingCapable;return fa;}function t(x){this.manager=x;(this.init&&this.init());}function u(x){t.apply(this,arguments);}g(u.prototype,{logName:'CORS',enterState:function(x,y){if(this._request){this._request.abort();this._request=null;}if(x=='init')setTimeout(h(this.manager,'exitState',{status:m.OK,stateId:y.stateId}),3000,false);if(!/pull|ping/.test(x))return;var z=this.manager;if(x=='ping'){this._request=r(y,h(z,'exitState',{status:m.OK,stateId:y.stateId}),h(z,'exitState',{status:m.ERROR,stateId:y.stateId}));}else if(x=='pull')this._request=s(y,h(z,'_processTransportData',y.stateId),h(z,'exitState',{status:m.OK,stateId:y.stateId}),h(z,'exitState',{status:m.ERROR,stateId:y.stateId}));}});function v(x){n.log('iframe_init_constructor');t.apply(this,arguments);this._iframe=document.createElement('iframe');this._iframe.style.display='none';document.body.appendChild(this._iframe);l.publish(this,'outerTransport');}g(v.prototype,{logName:'iframe',_initIframe:function(x){n.log('iframe_init_start');window.onchanneliframeready=function(){n.log('iframe_resources');return x.resources;};window.onchanneliframeloaded=function(){n.log('iframe_loaded');};if(x){this._iframeURI=p(x,x.path);if(x.bustIframe){var y={partition:x.partition,cb:o()};this._iframeURI.setQueryData(y);}}else this._iframeURI='about:blank';this._iframeProxy=null;try{this._iframe.contentWindow.location.replace(this._iframeURI);n.log('iframe_uri_set');}catch(z){n.error('iframe_uri_set_error',z);this.exitState({status:m.ERROR,stateId:x.stateId},z+'');}},enterState:function(x,y){if(x=='init'){this._initIframe(y);}else if(/idle|ping|pull/.test(x)){if(this._iframeProxy){this._iframeProxy.enterState.apply(this._iframeProxy,arguments);}else if(x!='idle')this.exitState({status:m.ERROR,stateId:y.stateId},'iframe not yet loaded');}else if(x=='shutdown')this._initIframe();},_processTransportData:function(){this.manager._processTransportData.apply(this.manager,arguments);},exitState:function(x){if(this.manager.state=='init'&&x.status==m.OK)this._iframeProxy=l.proxy(this._iframe.contentWindow,'innerTransport',['enterState'],(this._iframeURI+'').replace(/iframe.*/,''));if(/ping|pull/.test(this.manager.state)&&!this._iframeProxy)return;this.manager.exitState.apply(this.manager,arguments);}});function w(){this.init=this.init.bind(this);t.apply(this,arguments);}g(w.prototype,{logName:'iframe(inner)',init:function(){l.publish(this,'innerTransport');try{var y=l.proxy(window.parent,'outerTransport',['_processTransportData','exitState'],top.DocRPC.origin);g(this,y);this.exitState({status:m.OK,stateId:1e+06});}catch(x){n.error('iframe_inner_init_error',x);}},enterState:function(x,y){if(this._request){this._request.abort();this._request=null;}if(x=='ping'){this._request=r(y,h(this,'exitState',{status:m.OK,stateId:y.stateId}),h(this,'exitState',{status:m.ERROR,stateId:y.stateId}));}else if(x=='pull')this._request=s(y,h(this,'_processTransportData',y.stateId),h(this,'exitState',{status:m.OK,stateId:y.stateId}),h(this,'exitState',{status:m.ERROR,stateId:y.stateId}));}});e.exports={getURI:p,Transport:t,CORSTransport:u,IframeTransport:v,IframeInnerTransport:w};});
__d("FBAjaxRequest",["$","AjaxRequest","copyProperties","XHR"],function(a,b,c,d,e,f){var g=b('$'),h=b('AjaxRequest'),i=b('copyProperties'),j=b('XHR');function k(l,m,n){n=i(j.getAsyncParams(l),n);var o=new h(l,m,n),p=o._call;o._call=function(q){if(q=='onJSON'&&this.json){if(this.json.error){this.errorType=h.SERVER_ERROR;this.errorText='AsyncResponse error: '+this.json.error;}this.json=this.json.payload;}p.apply(this,arguments);};return o;}e.exports=k;});
__d("MovingStat",[],function(a,b,c,d,e,f){function g(h){h=h||60000;var i={t:new Date(),count:0,v:0},j=i,k=0,l=0;function m(){var n=new Date()-h;while(j&&j.next&&j.t<n){k-=j.v;l-=j.count;j=j.next;}}this.add=function(n){k+=n;l++;var o=new Date();if(o-i.t<1000){i.v+=n;i.count++;}else{i.next={t:o,v:n,count:1};i=i.next;m();}};this.tally=function(n){n=n||1000;m();return {sum:k,count:l,timeAverage:k*n/h};};}e.exports=g;});
__d("PresenceUtil",["Cookie","Env","randomInt","tx"],function(a,b,c,d,e,f){var g=b('Cookie'),h=b('Env'),i=b('randomInt'),j=b('tx'),k=i(0,4294967295)+1,l={checkMaintenanceError:function(m){if(m.getError()==1356007)return true;return false;},getErrorDescription:function(m){var n=m.getError(),o=m.getErrorDescription();if(!o)o="An error occurred.";if(n==1357001)o="Your session has timed out. Please log in.";return o;},getSessionID:function(){return k;},hasUserCookie:function(){return h.user===g.get('c_user');}};e.exports=l;});
__d("PresenceCookieManager",["Cookie","Dcode","ErrorUtils","Env","JSLogger","PresenceUtil","URI","PresenceInitialData"],function(a,b,c,d,e,f){var g=b('Cookie'),h=b('Dcode'),i=b('ErrorUtils'),j=b('Env'),k=b('JSLogger'),l=b('PresenceUtil'),m=b('URI'),n=c('PresenceInitialData'),o=n.cookieVersion,p=n.dictEncode,q='presence',r={},s=null,t=null,u=k.create('presence_cookie');function v(){try{var z=g.get(q);if(s!==z){s=z;t=null;if(z&&z.charAt(0)=='E')z=h.decode(z.substring(1));if(z)t=JSON.parse(z);}if(t&&(!t.user||t.user===j.user))return t;}catch(y){u.warn('getcookie_error');}return null;}function w(){return parseInt(new Date().getTime()/1000,10);}var x={register:function(y,z){r[y]=z;},store:function(){var y=v();if(y&&y.v&&o<y.v)return;var z={v:o,time:w(),user:j.user};for(var aa in r)z[aa]=i.applyWithGuard(r[aa],r,[y&&y[aa]],function(ea){ea.presence_subcookie=aa;});var ba=JSON.stringify(z);if(p)ba='E'+h.encode(ba);if(l.hasUserCookie()){var ca=ba.length;if(ca>1024)u.warn('big_cookie',ca);var da=m.getRequestURI(false).isSecure()&&!!g.get('csm');g.set(q,ba,null,null,da);}},clear:function(){g.clear(q);},getSubCookie:function(y){var z=v();if(!z)return null;return z[y];}};e.exports=x;});
__d("PresenceState",["Arbiter","ErrorUtils","JSLogger","PresenceCookieManager","copyProperties","debounceAcrossTransitions","setIntervalAcrossTransitions","PresenceInitialData"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ErrorUtils'),i=b('JSLogger'),j=b('PresenceCookieManager'),k=b('copyProperties'),l=b('debounceAcrossTransitions'),m=b('setIntervalAcrossTransitions'),n=c('PresenceInitialData'),o=n.cookiePollInterval||2000,p=[],q=[],r=null,s=null,t=0,u=null,v=0,w=['sb2','t2','lm2','uct2','tr','tw','at','wml'],x=i.create('presence_state');function y(){return j.getSubCookie('state');}function z(){t=Date.now();j.store();da(s);}var aa=l(z,0);function ba(ia){if(typeof ia=='undefined'||isNaN(ia)||ia==Number.POSITIVE_INFINITY||ia==Number.NEGATIVE_INFINITY)ia=0;return ia;}function ca(ia){var ja={};if(ia){w.forEach(function(ma){ja[ma]=ia[ma];});if(t<ia.ut)x.error('new_cookie',{cookie_time:ia.ut,local_time:t});}ja.ut=t;for(var ka=0,la=p.length;ka<la;ka++)h.applyWithGuard(p[ka],null,[ja]);s=ja;return s;}function da(ia){v++;t=ba(ia.ut);if(!r)r=m(ga,o);s=ia;if(u===null)u=ia;for(var ja=0,ka=q.length;ja<ka;ja++)h.applyWithGuard(q[ja],null,[ia]);v--;}function ea(ia){if(ia&&ia.ut)if(t<ia.ut){return true;}else if(ia.ut<t)x.error('old_cookie',{cookie_time:ia.ut,local_time:t});return false;}function fa(){var ia=y();if(ea(ia))s=ia;return s;}function ga(){var ia=y();if(ea(ia))da(ia);}j.register('state',ca);g.subscribe(i.DUMP_EVENT,function(ia,ja){ja.presence_state={initial:k({},u),state:k({},s),update_time:t,sync_paused:v,poll_time:o};});(function(){var ia=fa();if(ia){da(ia);}else{x.debug('no_cookie_initial');da(ca());return;}})();var ha={doSync:function(ia){if(v)return;if(ia){z();}else aa();},registerStateStorer:function(ia){p.push(ia);},registerStateLoader:function(ia){q.push(ia);},get:function(){return fa();},getInitial:function(){return u;},verifyNumber:ba};e.exports=ha;},3);
__d("ChannelManager",["event-extensions","function-extensions","AjaxRequest","Arbiter","AsyncRequest","ChannelConstants","ChannelSubdomain","ChannelTransport","Cookie","Env","FBAjaxRequest","JSLogger","MovingStat","PresenceCookieManager","PresenceState","PresenceUtil","Run","SystemEvents","URI","UserActivity","UserAgent","copyProperties","createArrayFrom","hasArrayNature","ChannelInitialData"],function(a,b,c,d,e,f){b('event-extensions');b('function-extensions');var g=b('AjaxRequest'),h=b('Arbiter'),i=b('AsyncRequest'),j=b('ChannelConstants'),k=b('ChannelSubdomain'),l=b('ChannelTransport'),m=b('Cookie'),n=b('Env'),o=b('FBAjaxRequest'),p=b('JSLogger'),q=b('MovingStat'),r=b('PresenceCookieManager'),s=b('PresenceState'),t=b('PresenceUtil'),u=b('Run'),v=b('SystemEvents'),w=b('URI'),x=b('UserActivity'),y=b('UserAgent'),z=b('copyProperties'),aa=b('createArrayFrom'),ba=b('hasArrayNature'),ca=c('ChannelInitialData'),da,ea=p.create('channel'),fa=null;function ga(sa){fa=sa;}var ha={idle:{ok:'init!'},init:{ok:'pull!',error:'reconnect',sys_online:'init',sys_timetravel:'init'},pull:{ok:'pull!',error:'ping',error_missing:'pull',error_msg_type:'pull',refresh_0:'reconnect',refresh_110:'reconnect',refresh_111:'pull',refresh_112:'pull',refresh_113:'pull',refresh_117:'reconnect'},ping:{ok:'pull!',error:'ping',error_stale:'reconnect!'},reconnect:{ok:'init!',error:'reconnect',sys_online:'reconnect',sys_timetravel:'reconnect'},shutdown:{},_all:{error_max:'shutdown!',error_shutdown:'shutdown!',sys_owner:'reconnect',sys_nonowner:'idle!',sys_online:'ping',sys_offline:'idle!',sys_timetravel:'ping'}},ia={userActive:Date.now(),sessionID:(Math.random()*2147483648|0).toString(16),streamingCapable:false,inStreaming:false,LONGPOLL_TIMEOUT:60000,STREAMING_TIMEOUT:60000,P_TIMEOUT:30000,IFRAME_LOAD_TIMEOUT:30000,MIN_RETRY_INTERVAL:5000,MAX_RETRY_INTERVAL:30000,MIN_12002_TIMEOUT:9000,MIN_504_TIMEOUT:20000,STALL_THRESHOLD:180000,JUMPSTART_THRESHOLD:90000,MIN_INIT_PROBE_DELAY:3000,INIT_PROBE_DELAY_RANDOMIZE_RANGE:12000,PROBE_DELAY:60000,PROBE_HEARTBEATS_INTERVAL_LOW:1000,PROBE_HEARTBEATS_INTERVAL_HIGH:3000,STREAMING_EXIT_STATE_ON_CONTINUE:false},ja=1,ka={},la=0;function ma(sa){return sa.toLowerCase().replace(/[^0-9a-z]+/g,'_');}function na(){return i.lastSuccessTime?Math.round((Date.now()-i.lastSuccessTime)/1000):-1;}function oa(){var sa={};if(da.getConfig('host'))sa[da.getConfig('user_channel')]=da.getConfig('seq',0);return sa;}function pa(){var sa=Date.now(),ta=Date.now(),ua={total:0},va='idle',wa=false;v.subscribe([v.USER,v.ONLINE,v.TIME_TRAVEL],function(za,ab){ra(true);ta=null;da.lastPullTime=Date.now();var bb;switch(za){case v.USER:bb=v.isPageOwner()?j.SYS_OWNER:j.SYS_NONOWNER;break;case v.ONLINE:bb=ab?j.SYS_ONLINE:j.SYS_OFFLINE;break;case v.TIME_TRAVEL:bb=j.SYS_TIMETRAVEL;break;}da.exitState({status:bb,stateId:ja});});var xa=function(za,ab){var bb=Date.now(),cb;if(ab){sa=bb;cb=ab.nextState||ab.state;}else cb=va;v.checkTimeTravel();if(ta){var db=Math.round((bb-ta)/1000);if(db>0){ua[va]=(ua[va]||0)+db;ua.total+=db;}}va=cb;ta=bb;if(!za){ua.lastSuccessTime=na();ua.online=v.isOnline();ea.log('rollup',ua);}};h.subscribe(j.ON_ENTER_STATE,xa);setInterval(xa,60000,false);h.subscribe(p.DUMP_EVENT,function(za,ab){ab.channelRollup=ua;});var ya=function(){if(da.isShutdown()||da.shouldIdle())return;v.checkTimeTravel();var za=Date.now()-(da.lastPullTime||n.start);if(!wa&&za>ia.STALL_THRESHOLD){var ab=na();ea.error('stall',{lastSuccessTime:ab,rollupState:va});wa=true;}var bb=Date.now()-sa;if(da.state=='pull'&&bb>ia.JUMPSTART_THRESHOLD){sa=null;ea.warn('jumpstart',{state:da.state,dormant:bb});da.enterState('init');}};setInterval(ya,10000,false);}function qa(){var sa=Date.now(),ta=1;function ua(){setTimeout(ua,ta*1000,false);var za=da.state;if(za=='idle'&&da.shouldIdle())return;ea.bump('conn_t',ta);if(za=='pull')ea.bump('conn_t_pull',ta);}ua();var va=[15,30,60,120,240],wa=false,xa=false;function ya(za){setTimeout(function(){ea.rate('pullenter_'+za,wa);ea.rate('pullexit_'+za,xa);},za*1000,false);}while(va.length)ya(va.shift());h.subscribe(j.ON_ENTER_STATE,function(za,ab){if(ab.state=='pull')wa=true;sa=Date.now();});h.subscribe(j.ON_EXIT_STATE,function(za,ab){if(ab.state!='pull'||!sa)return;var bb='other';if(ab.status==j.OK){xa=true;bb='ok';}else if(ab.xhr&&ab.xhr.errorType){bb=/ar:(\w+)/.test(ab.xhr.errorType)&&RegExp.$1;}else if(/^sys_/.test(ab.status))return;var cb=(Date.now()-sa)/1000;if(cb<0){return;}else if(cb>3600)cb=3600;ea.bump('conn_num');ea.bump('conn_exit',cb);ea.bump('conn_num_'+bb);ea.bump('conn_exit_'+bb,cb);});}function ra(sa){if(sa){la=0;ka={};}else la++;}da={state:'idle',nextState:null,lastPullTime:Date.now(),heartbeats:[],setTestCallback:ga,init:function(sa){this.init=function(){};if(typeof(x)!='undefined'){x.subscribe(function(){ia.userActive=Date.now();}.bind(this));}else ea.error('user_activity_undefined');r.register('ch',oa);var ta=this.getConfig('max_conn',2);ia.subdomain=k.allocate(ta);if(typeof window.onpageshow!='undefined'){Event.listen(window,'pagehide',k.clear);}else u.onUnload(k.clear);this._transportRate=new q(30000);var ua=(g.supportsCORS()&&!ia.forceIframe)?'CORSTransport':'IframeTransport';this.transport=new l[ua](this);if(sa)this.enterState.apply(this,arguments);h.subscribe(p.DUMP_EVENT,function(event,wa){wa.transportRate=this._transportRate.tally();wa.transportType=ua;wa.transportVersion=2;}.bind(this));pa();qa();if(da.getConfig('tryStreaming')&&da.getConfig('host')&&g.supportsCORS()&&!ia.forceIframe){var va=ia.MIN_INIT_PROBE_DELAY+Math.random()*ia.INIT_PROBE_DELAY_RANDOMIZE_RANGE;setTimeout(this._probeTest,va,false);}},configure:function(){var sa=aa(arguments);ea.log('configure',sa);sa.forEach(z.bind(null,ia));h.inform(j.ON_CONFIG,this);},getConfig:function(sa,ta){return sa in ia?ia[sa]:ta;},isShutdown:function(){return this.state=='shutdown';},shouldIdle:function(){return !(v.isPageOwner()&&v.isOnline());},_sendIframeError:function(sa){var ta=new i().setURI('/ajax/presence/reconnect.php').setData({reason:sa,fb_dtsg:n.fb_dtsg}).setOption('suppressErrorHandlerWarning',true).setOption('retries',1).setMethod('GET').setReadOnly(true).setAllowCrossPageTransition(true);ta.specifiesWriteRequiredParams()&&ta.send();},_getDelay:function(){var sa=Math.min(ia.MIN_RETRY_INTERVAL*Math.pow(2,Math.max(0,la-1)),ia.MAX_RETRY_INTERVAL);return sa*(.75+Math.random()/2)|0;},enterState:function(){if(this._inEnterState)ea.warn('enterstate_recursion');this._inEnterState=true;try{this._enterState.apply(this,arguments);this._inEnterState=false;}catch(sa){this._inEnterState=false;throw sa;}},_enterState:function(sa){var ta=0,ua=aa(arguments);if(this.isShutdown())return;if(sa!='idle!'&&this.shouldIdle())return;ja++;ia.stateId=ja;clearTimeout(this._deferredTransition);this._deferredTransition=null;this.transport.enterState('idle');this.state='idle';this.nextState=null;if(/!$/.test(sa)){var va=this._transportRate.tally().timeAverage,wa=da.getConfig('MAX_CHANNEL_STATES_PER_SEC',1);if(va>=wa){if(!this._throttled){this._throttled=true;ea.warn('throttled');}ea.bump('throttle');ta=1000/wa;}}else if(!(/#$/.test(sa)))ta=this._getDelay();sa=sa.replace(/\W*$/,'');if(!ha[sa])throw new Error('invalid state:'+sa);var xa;if(ta<=0){xa={state:sa};this._transportRate.add(1);this.state=sa;var ya=this['_enter_'+this.state];if(ya){ua.shift();ya.apply(this,ua);}if(/init|idle|pull|ping/.test(this.state)){if(ia.streamingCapable&&/pull/.test(this.state))this.heartbeats=[];this.transport.enterState(this.state,ia);if(this.state=='ping'){xa.url=l.getURI(ia).toString();xa.port=ia.port||'undefined';}}}else{this.state='idle';this.nextState=sa;xa={state:this.state,delay:ta,nextState:sa};ua[0]=sa+'#';this._deferredTransition=(function(){this._deferredTransition=null;this.enterState.apply(this,ua);}).bind(this).defer(ta,false);}if(/pull/.test(sa)){xa.client_id=ia.sessionID;xa.streaming=ia.inStreaming;}ea.log('enter_'+this.state,xa);h.inform(j.ON_ENTER_STATE,xa);},exitState:function(sa,ta){var ua=sa.stateId,va=sa.status;if(this.isShutdown()||ua<ja)return;var wa=aa(arguments),xa=this.state;wa[0]=sa.status;var ya={state:xa,status:va};if(/pull/.test(xa)){ya.client_id=ia.sessionID;ya.streaming=ia.inStreaming;}if(/ping/.test(xa)&&va!=j.OK)ya.url=l.getURI(ia).toString();if(this.nextState)ya.nextState=this.nextState;if(ta&&ta.errorType){ya.xhr=ta.toJSON?ta.toJSON():ta;delete ya.xhr.json;}if(ta&&ta.json){if(ta.json.t)ya.t=ta.json.t;if(ta.json.reason)ya.reason=ta.json.reason;if(ta.json.seq)ya.seq=ta.json.seq;}ea.log('exit_'+xa,ya);h.inform(j.ON_EXIT_STATE,ya);var za=this['_exit_'+xa];if(za)va=za.apply(this,wa)||va;if(va!=j.OK){ra();ka[xa]=(ka[xa]||0)+1;}var ab=ha[this.nextState||xa][va]||ha._all[va],bb=ab&&ab.replace(/!*$/,'');if(!bb){ea.error('terminal_transition',ya);this._shutdownHint=j.HINT_INVALID_STATE;ab='shutdown!';}this._lastState=xa;this._lastStatus=va;this.enterState(ab);},_processTransportData:function(sa,ta){var ua=ta.json,va=ua.t;if('s' in ua){ua.seq=ua.s;delete ua.s;}var wa=ia.seq;if('seq' in ua){ia.seq=ua.seq;s.doSync();}switch(va){case 'continue':if(ia.inStreaming&&this.heartbeats.length<1){ia.streamingCapable=false;ea.log('switch_to_longpoll');setTimeout(this._probeTest,ia.PROBE_DELAY,false);}ra(true);if(!ia.inStreaming||ia.STREAMING_EXIT_STATE_ON_CONTINUE)this.exitState({status:j.OK,stateId:sa});break;case 'refresh':case 'refreshDelay':this.exitState({status:'refresh_'+(ua.reason||0),stateId:sa},ta);break;case 'fullReload':r.clear();ea.log('invalid_history');h.inform(j.ON_INVALID_HISTORY);this.exitState({status:j.ERROR_MISSING,stateId:sa},ta);break;case 'msg':var xa,ya,za,ab;ra(true);ya=ua.ms;za=ia.seq-ya.length;for(xa=0;xa<ya.length;xa++,za++)if(za>=wa){ab=ya[xa];if(ab.type){ea.debug('message',{type:ab.type});h.inform(j.getArbiterType(ab.type),{obj:ab});}}else ea.warn('seq_regression',{seq:za,last_seq:wa,messages:ya.length});break;case 'heartbeat':if(ia.inStreaming){var bb=Date.now();if(this.heartbeats.length>0){var cb=bb-this.heartbeats[this.heartbeats.length-1];ea.log('heartbeat_interval',{client_id:ia.sessionID,interval:cb});}this.heartbeats.push(bb);}break;default:ea.error('unknown_msg_type',{type:va});break;}},_enter_init:function(){if(ka.init>=da.getConfig('MAX_INIT_FAILS',2))return this.exitState.bind(this,{status:j.ERROR_MAX,stateId:ja}).defer();this._initTimer=this.exitState.bind(this,{status:j.ERROR,stateId:ja},'timeout').defer(ia.IFRAME_LOAD_TIMEOUT,false);},_enter_reconnect:function(sa){var ta=ja;if(!t.hasUserCookie()){ea.warn('no_user_cookie');(function(){da._shutdownHint=j.HINT_AUTH;da.exitState({status:j.ERROR_SHUTDOWN,stateId:ta});}).defer();return;}var ua={reason:sa,fb_dtsg:n.fb_dtsg};if(n.fb_isb)ua.fb_isb=n.fb_isb;if(fa)fa(ua);var va=new o('GET','/ajax/presence/reconnect.php',ua);va.onSuccess=(function(){da.configure(va.json);r.store();this.exitState({status:j.OK,stateId:ta});}).bind(this);va.onError=(function(){var wa=va.json&&va.json.error;if(va.errorType==g.TRANSPORT_ERROR||va.errorType==g.PROXY_ERROR)this._shutdownHint=j.HINT_CONN;if(wa&&wa==1356007){this._shutdownHint=j.HINT_MAINT;}else if(wa==1357001||wa==1357004||wa==1348009){this._shutdownHint=j.HINT_AUTH;}else this._shutdownHint=null;this.exitState({status:this._shutdownHint?j.ERROR_SHUTDOWN:j.ERROR,stateId:ta},va);}).bind(this);va.send();},_enter_shutdown:function(){h.inform(j.ON_SHUTDOWN,{reason:this._shutdownHint});},_exit_init:function(sa){if(this._initTimer)this._initTimer=clearTimeout(this._initTimer);if(sa==j.ERROR_MAX)this._sendIframeError(j.reason_IFrameLoadGiveUp);},_exit_pull:function(sa){if(sa==j.OK)this.lastPullTime=Date.now();},_exit_ping:function(sa){if(sa==j.OK){var ta=Date.now()-(this.lastPullTime||n.start);if(ta>ia.STALL_THRESHOLD)return j.ERROR_STALE;}},_probeTest:function(){ia.streamingCapable=false;var sa=[],ta={mode:'stream',format:'json'},ua=new w('/probe').setDomain(ia.host+'.facebook.com').setPort(ia.port).setSecure(w().isSecure()).setQueryData(ta),va=new g('GET',ua);va.onJSON=function(wa,xa){if(wa&&wa.json&&wa.json.t==='heartbeat'){sa.push(Date.now());if(sa.length>=2){var ya=sa[1]-sa[0];if(ya>=ia.PROBE_HEARTBEATS_INTERVAL_LOW&&ya<=ia.PROBE_HEARTBEATS_INTERVAL_HIGH){ia.streamingCapable=true;ea.log('switch_to_streaming');}ea.log('probe_ok',{time:ya});}}};va.onSuccess=function(wa){if(sa.length!=2){ia.streamingCapable=false;ea.error('probe_error',{error:'beats.length = '+sa.length});}};va.onError=function(wa){ia.streamingCapable=false;ea.error('probe_error',wa);};ea.log('probe_request');va.send();}};e.exports=da;if(ca.serverInitialized==null){da.configure(ca.channelConfig);if(/shutdown/.test(ca.state))da._shutdownHint=j[ca.reason];da.init(ca.state,ca.reason);}});
__d("ChannelConnection",["Arbiter","copyProperties","ChatConfig","Run","SystemEvents","ChannelConstants","ChannelManager","JSLogger"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('ChatConfig'),j=b('Run'),k=b('SystemEvents'),l=b('ChannelConstants'),m=b('ChannelManager'),n=b('JSLogger'),o=n.create('channel_connection'),p=null,q=null,r=null,s=null,t=0,u=h(new g(),{CONNECTED:'chat-connection/connected',RECONNECTING:'chat-connection/reconnecting',SHUTDOWN:'chat-connection/shutdown',MUTE_WARNING:'chat-connection/mute',UNMUTE_WARNING:'chat-connection/unmute'});function v(){if(q){clearTimeout(q);q=null;}}function w(){v();o.log('unmute_warning');u.inform(u.UNMUTE_WARNING);}function x(ba){v();q=w.defer(ba,false);o.log('mute_warning',{time:ba});u.inform(u.MUTE_WARNING);}function y(){if(r){clearTimeout(r);r=null;}}function z(ba,ca){y();if(ba===l.ON_ENTER_STATE&&(ca.nextState||ca.state)==='pull'){if(s!==u.CONNECTED){o.log('connected');var da=!s;s=u.CONNECTED;t=0;u.inform(u.CONNECTED,{init:da});}}else if(ba===l.ON_ENTER_STATE&&((ca.nextState||ca.state)==='ping'||(!ca.nextState&&ca.state==='idle'))){r=(function(){var ea=null;if(!(ca.state==='idle'&&!ca.nextState))ea=(ca.delay||0);o.log('reconnecting',{delay:ea});if(u.disconnected())o.log('reconnecting_ui',{delay:ea});s=u.RECONNECTING;(ca.state==='idle')&&t++;if(t>1){u.inform(u.RECONNECTING,ea);}else if(!ca.nextState&&ca.state==='idle')z(ba,ca);}).defer(500,false);}else if(ba===l.ON_SHUTDOWN){o.log('shutdown',{reason:ca.reason});s=u.SHUTDOWN;t=0;u.inform(u.SHUTDOWN,ca.reason);}}function aa(ba){if(m.state==='ping'||m.isShutdown())return;o.log('reconnect',{now:ba});u.inform(u.RECONNECTING,0);if(!!ba){if(p!==null){clearTimeout(p);p=null;}m.enterState('ping!');}else if(!p)p=setTimeout(function(){m.enterState('ping!');p=null;},i.get('channel_manual_reconnect_defer_msec'),false);}if(m.isShutdown()){z(l.ON_SHUTDOWN,m._shutdownHint);}else z(l.ON_ENTER_STATE,{state:m.state,nextState:m.nextState,delay:0});g.subscribe([l.ON_ENTER_STATE,l.ON_SHUTDOWN],z);k.subscribe(k.TIME_TRAVEL,function(){aa();x(i.get('mute_warning_time_msec'));});j.onBeforeUnload(y,false);h(u,{disconnected:function(){return s===u.SHUTDOWN||(s===u.RECONNECTING&&!q&&t>1);},isShutdown:function(){return s===u.SHUTDOWN;},reconnect:aa,unmuteWarning:w});e.exports=u;});
__d("legacy:ChannelConstants",["ChannelConstants"],function(a,b,c,d){a.ChannelConstants=b('ChannelConstants');},3);
__d("ChatOptions",["Arbiter","ChannelConstants","JSLogger","PresenceUtil","copyProperties","ChatOptionsInitialData"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ChannelConstants'),i=b('JSLogger'),j=b('PresenceUtil'),k=b('copyProperties'),l=i.create('chat_options'),m={};(function(){var o=c('ChatOptionsInitialData');for(var p in o){var q=o[p];m[p]=!!q;}})();var n=k(new g(),{getSetting:function(o){return m[o];},setSetting:function(o,p,q){if(this.getSetting(o)==p)return;if(q){q='from_'+q;l.log(q,{name:o,new_value:p,old_value:this.getSetting(o)});}m[o]=!!p;g.inform('chat/option-changed',{name:o,value:p});}});g.subscribe(h.getArbiterType('setting'),function(o,p){var q=p.obj;if(q.window_id===j.getSessionID())return;n.setSetting(q.setting,!!q.value,'channel');});g.subscribe(i.DUMP_EVENT,function(o,p){p.chat_options=m;});e.exports=n;});
__d("CallbackManagerController",["ErrorUtils","copyProperties"],function(a,b,c,d,e,f){var g=b('ErrorUtils'),h=b('copyProperties'),i=function(j){this._pendingIDs=[];this._allRequests=[undefined];this._callbackArgHandler=j;};h(i.prototype,{executeOrEnqueue:function(j,k,l){l=l||{};var m=this._attemptCallback(k,j,l);if(m)return 0;this._allRequests.push({fn:k,request:j,options:l});var n=this._allRequests.length-1;this._pendingIDs.push(n);return n;},unsubscribe:function(j){delete this._allRequests[j];},reset:function(){this._allRequests=[];},getRequest:function(j){return this._allRequests[j];},runPossibleCallbacks:function(){var j=this._pendingIDs;this._pendingIDs=[];var k=[];j.forEach(function(l){var m=this._allRequests[l];if(!m)return;if(this._callbackArgHandler(m.request,m.options)){k.push(l);}else this._pendingIDs.push(l);}.bind(this));k.forEach(function(l){var m=this._allRequests[l];delete this._allRequests[l];this._attemptCallback(m.fn,m.request,m.options);}.bind(this));},_attemptCallback:function(j,k,l){var m=this._callbackArgHandler(k,l);if(m){var n={ids:k};g.applyWithGuard(j,n,[m]);}return !!m;}});e.exports=i;});
__d("KeyedCallbackManager",["CallbackManagerController","ErrorUtils","copyProperties"],function(a,b,c,d,e,f){var g=b('CallbackManagerController'),h=b('ErrorUtils'),i=b('copyProperties'),j=function(){this._resources={};this._controller=new g(this._constructCallbackArg.bind(this));};i(j.prototype,{executeOrEnqueue:function(k,l){if(!(k instanceof Array)){var m=k,n=l;k=[k];l=function(o){n(o[m]);};}k=k.filter(function(o){var p=(o!==null&&o!==undefined);if(!p)h.applyWithGuard(function(){throw new Error('KeyedCallbackManager.executeOrEnqueue: key '+JSON.stringify(o)+' is invalid');});return p;});return this._controller.executeOrEnqueue(k,l);},unsubscribe:function(k){this._controller.unsubscribe(k);},reset:function(){this._controller.reset();this._resources={};},getUnavailableResources:function(k){var l=this._controller.getRequest(k),m=[];if(l)m=l.request.filter(function(n){return !this._resources[n];}.bind(this));return m;},addResourcesAndExecute:function(k){i(this._resources,k);this._controller.runPossibleCallbacks();},setResource:function(k,l){this._resources[k]=l;this._controller.runPossibleCallbacks();},getResource:function(k){return this._resources[k];},getAllResources:function(){return this._resources;},dumpResources:function(){var k={};for(var l in this._resources){var m=this._resources[l];if(typeof m==='object')m=i({},m);k[l]=m;}return k;},_constructCallbackArg:function(k){var l={};for(var m=0;m<k.length;m++){var n=k[m],o=this._resources[n];if(typeof o=='undefined')return false;l[n]=o;}return l;}});e.exports=j;});
__d("AsyncLoader",["AsyncRequest","KeyedCallbackManager","copyProperties"],function(a,b,c,d,e,f){var g=b('AsyncRequest'),h=b('KeyedCallbackManager'),i=b('copyProperties'),j={};function k(m,n){var o=new h(),p=false,q=[];function r(){if(!q.length||p)return;p=true;t.defer();}function s(w){p=false;w.forEach(o.unsubscribe.bind(o));r();}function t(){var w={},x=[];q=q.filter(function(z){var aa=o.getUnavailableResources(z);if(aa.length){aa.forEach(function(ba){w[ba]=true;});x.push(z);return true;}return false;});var y=Object.keys(w);if(y.length){new g(m).setData({ids:y}).setHandler(u.curry(x)).setErrorHandler(v.curry(x)).setAllowCrossPageTransition(true).setMethod('GET').setReadOnly(true).send();}else p=false;}function u(w,x){var y=x.payload[n]||x.payload;o.addResourcesAndExecute(y);s(w);}function v(w){s(w);}return {get:function(w,x){var y=o.executeOrEnqueue(w,x),z=o.getUnavailableResources(y);if(z.length){q.push(y);r();}},getCachedKeys:function(){return Object.keys(o.getAllResources());},getNow:function(w){return o.getResource(w)||null;},set:function(w){o.addResourcesAndExecute(w);}};}function l(m,n){this._endpoint=m;this._type=n;}i(l.prototype,{_getLoader:function(){if(!j[this._endpoint])j[this._endpoint]=k(this._endpoint,this._type);return j[this._endpoint];},get:function(m,n){return this._getLoader().get(m,n);},getCachedKeys:function(){return this._getLoader().getCachedKeys();},getNow:function(m){return this._getLoader().getNow(m);},reset:function(){j[this._endpoint]=null;},set:function(m){this._getLoader().set(m);}});e.exports=l;});
__d("ShortProfiles",["ArbiterMixin","AsyncLoader","AsyncRequest","Env","JSLogger","copyProperties"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('AsyncLoader'),i=b('AsyncRequest'),j=b('Env'),k=b('JSLogger'),l=b('copyProperties'),m='/ajax/chat/user_info.php',n='/ajax/chat/user_info_all.php',o=new h(m,'profiles'),p=false,q=k.create('short_profiles');function r(){if(!p){q.log('fetch_all');p=true;new i(n).setData({viewer:j.user}).setHandler(function(u){o.set(u.payload);t.inform('updated');}).setAllowCrossPageTransition(true).setMethod('GET').setReadOnly(true).send();}}function s(u){return JSON.parse(JSON.stringify(u));}var t={};l(t,g,{get:function(u,v){this.getMulti([u],function(w){v(w[u],u);});},getMulti:function(u,v){function w(x){v(s(x));}o.get(u,w);},getNow:function(u){return s(o.getNow(u)||null);},getCachedProfileIDs:function(){return o.getCachedKeys();},hasAll:function(){return p;},fetchAll:function(){r();},set:function(u,v){var w={};w[u]=v;this.setMulti(w);},setMulti:function(u){o.set(s(u));}});e.exports=t;});
__d("RangedCallbackManager",["CallbackManagerController","copyProperties","createObjectFrom"],function(a,b,c,d,e,f){var g=b('CallbackManagerController'),h=b('copyProperties'),i=b('createObjectFrom'),j=function(k,l,m){this._resources=[];this._reachedEndOfArray=false;this._error=false;this._existingIDs={};this._controller=new g(this._constructCallbackArg.bind(this));this._getValueHandler=k;this._compareValuesHandler=l;this._skipOnStrictHandler=m;};h(j.prototype,{executeOrEnqueue:function(k,l,m,n){return this._controller.executeOrEnqueue({start:k,limit:l},m,{strict:!!n});},unsubscribe:function(k){this._controller.unsubscribe(k);},getUnavailableResources:function(k){var l=this._controller.getRequest(k),m=[];if(l&&!this._reachedEndOfArray){var n=l.request,o=this._filterForStrictResults(l.options),p=n.start+n.limit;for(var q=o.length;q<p;q++)m.push(q);}return m;},addResources:function(k){k.forEach(function(l){if(!this._existingIDs[l]){this._existingIDs[l]=true;this._resources.push(l);}}.bind(this));this.resortResources();this._controller.runPossibleCallbacks();},addResourcesWithoutSorting:function(k,l){var m=this._resources.slice(0,l);m=m.concat(k);m=m.concat(this._resources.slice(l));this._resources=m;h(this._existingIDs,i(k,true));this._controller.runPossibleCallbacks();},removeResources:function(k){k.forEach(function(l){if(this._existingIDs[l]){this._existingIDs[l]=false;this._resources.remove(l);}}.bind(this));},removeAllResources:function(){this._resources=[];this._existingIDs={};},resortResources:function(){this._resources=this._resources.sort(function(k,l){return this._compareValuesHandler(this._getValueHandler(k),this._getValueHandler(l));}.bind(this));},setReachedEndOfArray:function(){if(!this._reachedEndOfArray){this._reachedEndOfArray=true;this._controller.runPossibleCallbacks();}},hasReachedEndOfArray:function(){return this._reachedEndOfArray;},setError:function(k){this._error=k;},hasResource:function(k){return this._existingIDs[k];},getResourceAtIndex:function(k){return this._resources[k];},getAllResources:function(){return this._resources.concat();},getCurrentArraySize:function(){return this._resources.length;},_filterForStrictResults:function(k){var l=this._resources;if(k&&k.strict&&this._skipOnStrictHandler)l=l.filter(this._skipOnStrictHandler);return l;},_constructCallbackArg:function(k,l){var m=this._filterForStrictResults(l);if(!this._reachedEndOfArray&&k.start+k.limit>m.length){return false;}else return m.slice(k.start,k.start+k.limit);},getElementsUntil:function(k){var l=[];for(var m=0;m<this._resources.length;m++){var n=this._getValueHandler(this._resources[m]);if(this._compareValuesHandler(n,k)>0)break;l.push(this._resources[m]);}return l;}});e.exports=j;});
__d("MercuryServerDispatcher",["AsyncRequest","JSLogger","URI","areObjectsEqual","copyProperties","debounceAcrossTransitions"],function(a,b,c,d,e,f){var g=b('AsyncRequest'),h=b('JSLogger'),i=b('URI'),j=b('areObjectsEqual'),k=b('copyProperties'),l=b('debounceAcrossTransitions'),m={},n=h.create('mercury_dispatcher'),o=false,p={IMMEDIATE:'immediate',IDEMPOTENT:'idempotent',BATCH_SUCCESSIVE:'batch-successive',BATCH_SUCCESSIVE_UNIQUE:'batch-successive-unique',BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR:'batch-successive-piggyback-retry',BATCH_DEFERRED_MULTI:'batch-deferred-multi',BATCH_CONDITIONAL:'batch-conditional',registerEndpoints:function(r){for(var s in r){var t=r[s];m[s]=new q(s,t);}},trySend:function(r,s,t){m[r].trySend(s,t);}};function q(r,s){var t=s.mode||p.IMMEDIATE;switch(t){case p.IMMEDIATE:case p.IDEMPOTENT:case p.BATCH_SUCCESSIVE:case p.BATCH_SUCCESSIVE_UNIQUE:case p.BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR:case p.BATCH_DEFERRED_MULTI:case p.BATCH_CONDITIONAL:break;default:throw new Error('Invalid MercuryServerDispatcher mode '+t);}this._endpoint=r;this._mode=t;this._combineData=s.batch_function;this._combineDataIf=s.batch_if;this._handler=s.handler;this._errorHandler=s.error_handler;this._transportErrorHandler=s.transport_error_handler||s.error_handler;this._serverDialogCancelHandler=s.server_dialog_cancel_handler||s.error_handler;this._deferredSend=l(this._batchSend,0,this);}k(q.prototype,{_inFlight:0,_handler:null,_errorHandler:null,_transportErrorHandler:null,_serverDialogCancelHandler:null,_combineData:null,trySend:function(r,s){if(o)return;if(typeof r=='undefined')r=null;var t=s||this._mode;if(t==p.IMMEDIATE){this._send(r);}else if(t==p.IDEMPOTENT){if(!this._inFlight)this._send(r);}else if(t==p.BATCH_SUCCESSIVE||t==p.BATCH_SUCCESSIVE_UNIQUE){if(!this._inFlight){this._send(r);}else this._batchData(r);}else if(t==p.BATCH_CONDITIONAL){if(this._inFlight&&(this._combineDataIf(this._pendingRequestData,r)||this._combineDataIf(this._batchedData,r))){this._batchData(r);}else this._send(r);}else if(t==p.BATCH_DEFERRED_MULTI){this._batchData(r);this._deferredSend();}else if(t==p.BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR){this._batchData(r);if(!this._inFlight)this._batchSend();}},_send:function(r){this._inFlight++;this._pendingRequestData=k({},r);n.log('send',{endpoint:this._endpoint,data:r,inflight_count:this._inFlight});new g(this._endpoint).setData(r).setHandler(this._handleResponse.bind(this)).setErrorHandler(this._handleError.bind(this)).setTransportErrorHandler(this._handleTransportError.bind(this)).setServerDialogCancelHandler(this._handleServerDialogCancel.bind(this)).setAllowCrossPageTransition(true).send();},_batchData:function(r){if(this._mode==p.BATCH_SUCCESSIVE_UNIQUE&&typeof this._pendingRequestData!='undefined'&&j(r,this._pendingRequestData)){return;}else if(typeof this._batchedData=='undefined'){this._batchedData=r;}else this._batchedData=this._combineData(this._batchedData,r);},_batchSend:function(){if(typeof this._batchedData!='undefined'){this._send(this._batchedData);delete this._batchedData;}},_handleResponse:function(r){this._inFlight--;n.log('response',{endpoint:this._endpoint,inflight_count:this._inFlight});var s=r.getPayload();o=s&&s.kill_chat;if(o)n.log('killswitch_enabled',{endpoint:this._endpoint,inflight_count:this._inFlight});if(s&&s.error_payload){if(this._errorHandler)this._errorHandler(r);}else this._handler&&this._handler(s);if(this._mode==p.BATCH_SUCCESSIVE||this._mode==p.BATCH_SUCCESSIVE_UNIQUE||this._mode==p.BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR||this._mode==p.BATCH_CONDITIONAL)this._batchSend();delete this._pendingRequestData;},_handleErrorCommon:function(r,s){n.error('error',{endpoint:this._endpoint,inflight_count:this._inFlight-1});s&&s(r);this._inFlight--;var t=this._mode;if(t==p.BATCH_SUCCESSIVE||t==p.BATCH_SUCCESSIVE_UNIQUE||t==p.BATCH_CONDITIONAL){this._batchSend();}else if(t==p.BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR)if(typeof this._batchedData=='undefined'){this._batchedData=this._pendingRequestData;}else{this._batchedData=this._combineData(this._pendingRequestData,this._batchedData);this._batchSend();}delete this._pendingRequestData;},_handleError:function(r){this._handleErrorCommon(r,this._errorHandler);},_handleTransportError:function(r){this._handleErrorCommon(r,this._transportErrorHandler);},_handleServerDialogCancel:function(r){this._handleErrorCommon(r,this._serverDialogCancelHandler);}});e.exports=p;});
__d("MessagingReliabilityLogger",["function-extensions","AsyncRequest","copyProperties","isEmpty","PresenceUtil","Run","MercuryServerDispatcher","setTimeoutAcrossTransitions","MessagingReliabilityLoggerInitialData"],function(a,b,c,d,e,f){b('function-extensions');var g=b('AsyncRequest'),h=b('copyProperties'),i=b('isEmpty'),j=b('PresenceUtil'),k=b('Run'),l=b('MercuryServerDispatcher'),m=b('setTimeoutAcrossTransitions'),n=c('MessagingReliabilityLoggerInitialData'),o='/ajax/mercury/client_reliability.php',p=60000;function q(w,x){var y={app:n.app,categories:JSON.stringify(w)};if(!i(x))y.extra=JSON.stringify(x);return y;}function r(w,x,y,z){if(w[x]===undefined)w[x]={};if(w[x][y]===undefined)w[x][y]=0;w[x][y]+=z;}function s(w,x,y,z){if(w[x]===undefined)w[x]={};if(w[x][y]===undefined)w[x][y]=[];for(var aa=0;aa<z.length;++aa)w[x][y].push(z[aa]);}function t(w,x){if(!w.categories||!x.categories)return;var y=JSON.parse(w.categories),z=w.extra?JSON.parse(w.extra):{},aa=JSON.parse(x.categories),ba=x.extra?JSON.parse(x.extra):{};for(var ca in aa){var da=aa[ca],ea=ba[ca];for(var fa in da){r(y,ca,fa,da[fa]);if(ea!==undefined){var ga=ea[fa];if(ga!==undefined)s(z,ca,fa,ga);}}}return q(y,z);}var u={};u[o]={mode:l.BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR,batch_function:t};l.registerEndpoints(u);var v={addEntry:function(w,x,y){if(!n.enabled)return;var z={};r(z,w,x,1);var aa={};if(y!==undefined)s(aa,w,x,[y]);l.trySend(o,q(z,aa));}};(function w(){v.addEntry('page_event','active',j.getSessionID());m(w,p);})();e.exports=v;});
__d("MercuryIDs",[],function(a,b,c,d,e,f){function g(h){return typeof h==='string'&&h.indexOf(':')!==-1;}e.exports={isValid:function(h){if(!h)return false;return g(h);},tokenize:function(h){if(!this.isValid(h))throw 'bad_id_format';var i=h.indexOf(':');return {type:h.substr(0,i),value:h.substr(i+1)};}};});
__d("MercuryAssert",["MercuryIDs"],function(a,b,c,d,e,f){var g=b('MercuryIDs');e.exports={isParticipantID:function(h){if(!g.isValid(h))throw 'bad_participant_id';},allParticipantIDs:function(h){h.forEach(this.isParticipantID);},isUserParticipantID:function(h){var i=g.tokenize(h);if(i.type!='fbid')throw 'bad_user_id';},isEmailParticipantID:function(h){var i=g.tokenize(h);if(i.type!='email')throw 'bad_email_id';},allThreadID:function(h){h.forEach(this.isThreadID);},isThreadID:function(h){if(!g.isValid(h))throw 'bad_thread_id';}};});
__d("TimestampConverter",["JSLogger"],function(a,b,c,d,e,f){var g=b('JSLogger'),h=g.create('timestamp_converter');function i(k){return (typeof(k)=='string')&&k.length>6;}var j={convertActionIDToTimestamp:function(k){if(i(k)){var l=k.slice(0,-6);return parseInt(l,10);}},maxValidActionID:function(k,l){if(!i(k))return l;if(!i(l))return k;return this.isGreaterThan(k,l)?k:l;},isGreaterThan:function(k,l){if(!i(k)||!i(l))return false;return this.convertActionIDToTimestamp(k)>this.convertActionIDToTimestamp(l);}};e.exports=j;});
__d("MercuryMessageIDs",["KeyedCallbackManager"],function(a,b,c,d,e,f){var g=b('KeyedCallbackManager'),h=new g(),i={getServerIDs:function(j,k){var l=j.filter(function(n){return n.indexOf('mail.projektitan.com')!==-1;}),m=function(n){var o=j.map(function(p){return n[p]?n[p]:p;});k(o);};return h.executeOrEnqueue(l,m);},addServerID:function(j,k){h.setResource(j,k);}};e.exports=i;});
__d("MercuryThreadInformer",["Arbiter","copyProperties","MercuryAssert"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('MercuryAssert'),j={},k={},l={},m=false,n=false,o=false,p={},q={},r={},s=0;function t(){if(!s){var v=j,w=k,x=l,y=m,z=n,aa=o,ba=p,ca=q,da=r;j={};k={};l={};m=false;n=false;o=false;p={};q={};r={};var ea=Object.keys(w);if(ea.length||y)u.inform('threadlist-updated',ea);if(ea.length)u.inform('threads-updated',w);for(var fa in x){u.inform('thread-read-changed',x);break;}for(var fa in v){u.inform('threads-deleted',v);break;}if(z)u.inform('unseen-updated',null);if(aa)u.inform('unread-updated',null);for(fa in ba){u.inform('messages-received',ba);break;}for(fa in ca){u.inform('messages-reordered',ca);break;}for(fa in da){u.inform('messages-updated',da);break;}}}var u=h(new g(),{updatedThread:function(v){k[v]=true;t();},deletedThread:function(v){j[v]=true;t();},updatedThreadlist:function(){m=true;t();},updatedUnseenState:function(){n=true;t();},updatedUnreadState:function(){o=true;t();},changedThreadReadState:function(v,w,x){if(!l[v]||l[v].timestamp<x)l[v]={mark_as_read:w,timestamp:x};t();},receivedMessage:function(v){i.isThreadID(v.thread_id);var w=v.thread_id;if(!p[w])p[w]=[];p[w].push(v);u.updatedThread(w);},reorderedMessages:function(v,w){q[v]={source:w};t();},updatedMessage:function(v,w,x){if(!r[v])r[v]={};r[v][w]={source:x};t();},synchronizeInforms:function(v){s++;try{v();}catch(w){throw w;}finally{s--;t();}},listen:function(v,w){return u.subscribe('threads-updated',function(x,y){if(y[v])w(v);});}});e.exports=u;});
__d("MercuryServerRequests",["Arbiter","AsyncResponse","KeyedCallbackManager","TimestampConverter","copyProperties","Env","JSLogger","MercuryAssert","MercuryMessageIDs","MercuryServerDispatcher","MercuryThreadInformer","MercuryIDs","MessagingReliabilityLogger","createObjectFrom","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AsyncResponse'),i=b('KeyedCallbackManager'),j=b('TimestampConverter'),k=b('copyProperties'),l=b('Env'),m=b('JSLogger'),n=b('MercuryAssert'),o=b('MercuryMessageIDs'),p=b('MercuryServerDispatcher'),q=b('MercuryThreadInformer'),r=b('MercuryIDs'),s=b('MessagingReliabilityLogger'),t=b('createObjectFrom'),u=c('MercuryConstants'),v=u.MercuryGenericConstants,w=0,x=m.create('mercury_server'),y=new i(),z=new i(),aa=[],ba={},ca={},da=u.MercuryAPIArgsSource&&u.MercuryAPIArgsSource.MERCURY;function ea(ab){if(ab)w=j.maxValidActionID(w,ab);}function fa(ab){var bb=ab.thread_id,cb=y.getResource(bb);if(!cb){if(ab.is_canonical){if(ab.canonical_fbid===undefined){var db=ab.participants.filter(function(fb){return fb!='fbid:'+l.user;});if(db.length){var eb=r.tokenize(db[0]);if(eb.type=='email'){ab.canonical_email=eb.value;}else ab.canonical_fbid=eb.value;}else ab.canonical_fbid=l.user;}cb=ab.canonical_fbid?'user:'+ab.canonical_fbid:'email:'+ab.canonical_email;}else if(ab.root_message_threading_id)cb='root:'+ab.root_message_threading_id;cb=cb||'thread:'+bb;ga(bb,cb);}ab.thread_id=cb;}function ga(ab,bb){y.setResource(ab,bb);z.setResource(bb,ab);ca[ab]=bb;}function ha(ab,bb){var cb=z.executeOrEnqueue(ab,bb),db=z.getUnavailableResources(cb),eb=xa.tokenizeThreadID(ab);if(db.length&&eb.type!='root')xa.fetchThreadData(db);}function ia(ab){return z.getResource(ab);}function ja(ab){return !!y.getResource(ab);}function ka(ab){var bb=y.getResource(ab);if(typeof bb=='undefined')x.warn('no_client_thread_id',{server_id:ab});return bb;}function la(ab,bb){y.executeOrEnqueue(ab,bb);xa.ensureThreadIsFetched(ab);}function ma(ab,bb){if(ab.action_type!=u.MercuryActionType.SEND_MESSAGE)return;var cb=ab.client_thread_id;if(!cb)cb=ka(ab.thread_id);var db=null;if(cb)db=r.tokenize(cb).type;s.addEntry('send_'+db,bb,ab.thread_id+','+ab.message_id);}function na(ab){var bb=null;switch(ab.status){case u.MercuryActionStatus.SUCCESS:bb='success';break;case u.MercuryActionStatus.FAILED_UNKNOWN_REASON:bb='confirmed_error';break;case u.MercuryActionStatus.UNABLE_TO_CONFIRM:bb='confirm_error';break;default:return;}ma(ab,bb);}function oa(ab){(ab.message_counts||[]).forEach(function(jb){ea(jb.last_action_id);});(ab.threads||[]).forEach(function(jb){fa(jb);delete ba[jb.thread_id];delete ba[ia(jb.thread_id)];ea(jb.last_action_id);});(ab.ordered_threadlists||[]).forEach(function(jb){jb.thread_ids=jb.thread_ids.map(ka);});ab.actions=ab.actions||[];ab.actions.forEach(function(jb){na(jb);if(jb.status&&jb.status!=u.MercuryActionStatus.SUCCESS&&!jb.thread_id){jb.thread_id=jb.client_thread_id;return;}if(jb.action_type==u.MercuryActionType.SEND_MESSAGE&&jb.client_thread_id&&jb.client_thread_id!=v.PENDING_THREAD_ID)ga(jb.thread_id,jb.client_thread_id);jb.server_thread_id=jb.thread_id;jb.thread_id=ja(jb.thread_id)?ka(jb.thread_id):null;ea(jb.action_id);});if(ab.end_of_history){var bb=[];for(var cb=0;cb<ab.end_of_history.length;cb++){var db=ab.end_of_history[cb];if(db.type=='user'){bb.push('user:'+db.id);}else if(db.type=='thread'&&ja(db.id))bb.push(ka(db.id));}ab.end_of_history=bb;}if(ab.roger){var eb={};for(var fb in ab.roger){var gb=y.getResource(fb);if(gb){var hb=ab.roger[fb];eb[gb]={};for(var ib in hb)eb[gb]['fbid:'+ib]=hb[ib];}}ab.roger=eb;}}function pa(){if(aa&&aa.length){var ab=aa[0];aa=aa.slice(1);xa.handleUpdate(ab);}}function qa(ab,bb){var cb=k({},ab),db;if(bb.threads){if(!cb.threads)cb.threads={};for(db in bb.threads)cb.threads[db]=Object.keys(t((cb.threads[db]||[]).concat(bb.threads[db])));}if(bb.messages){if(!cb.messages)cb.messages={};for(db in bb.messages){if(!cb.messages[db])cb.messages[db]={};for(var eb in bb.messages[db])if(cb.messages[db][eb]){cb.messages[db][eb]=ta(cb.messages[db][eb],bb.messages[db][eb]);}else cb.messages[db][eb]=bb.messages[db][eb];}}cb.client=ab.client||bb.client;return cb;}function ra(ab,bb){var cb=k(t(ab.folders,true),t(bb.folders,true)),db=ab.client||bb.client;return {folders:Object.keys(cb),client:db};}function sa(ab,bb){for(var cb in bb)if(ab[cb]&&typeof ab[cb]==='object'){ab[cb]=ta(ab[cb],bb[cb]);}else if(bb[cb]&&typeof bb[cb]==='object'){var db={};k(db,bb[cb]);ab[cb]=db;}return ab;}function ta(ab,bb){var cb=ab.offset<bb.offset?ab.offset:bb.offset,db=ab.offset+ab.limit,eb=bb.offset+bb.limit,fb=(db>eb)?db:eb,gb=fb-cb;return {offset:cb,limit:gb};}function ua(ab,bb){var cb=ab.client||bb.client,db={ids:{},client:cb};k(db.ids,ab.ids);k(db.ids,bb.ids);return db;}function va(ab,bb){var cb={},db,eb=ab.client||bb.client;delete ab.client;delete bb.client;for(db in ab)k(cb,t(ab[db],db));for(db in bb)k(cb,t(bb[db],db));var fb={client:eb};for(var gb in cb){db=cb[gb];if(!fb[db])fb[db]=[];fb[db].push(gb);}return fb;}function wa(ab,bb){var cb=ab.client||bb.client,db=t(ab.ids,true),eb=t(bb.ids,true),fb=k(db,eb);return {ids:Object.keys(fb),client:cb};}var xa=k(new g(),{tokenizeThreadID:function(ab){n.isThreadID(ab);return r.tokenize(ab);},getServerThreadID:function(ab,bb){n.isThreadID(ab);ha(ab,bb);},getClientThreadID:function(ab,bb){la(ab,bb);},getClientThreadIDNow:function(ab){return ka(ab);},getServerThreadIDNow:function(ab){return ia(ab);},convertThreadIDIfAvailable:function(ab){var bb=y.getResource(ab);if(bb===undefined){return ab;}else return bb;},canLinkExternally:function(ab){n.isThreadID(ab);var bb=xa.tokenizeThreadID(ab);return (bb.type=='user')||!!ia(ab);},fetchThreadlistInfo:function(ab,bb,cb,db,eb){cb=cb||u.MessagingTag.INBOX;eb=eb||da;var fb=db?p.IMMEDIATE:null,gb={client:eb};gb[cb]={offset:ab,limit:bb,filter:db};p.trySend('/ajax/mercury/threadlist_info.php',gb,fb);},fetchUnseenThreadIDs:function(ab,bb){bb=bb||da;xa.fetchThreadlistInfo(u.MercuryThreadlistConstants.RECENT_THREAD_OFFSET,u.MercuryThreadlistConstants.JEWEL_THREAD_COUNT,ab,null,bb);},fetchUnreadThreadIDs:function(ab,bb){bb=bb||da;p.trySend('/ajax/mercury/unread_threads.php',{folders:[ab],client:bb});},fetchMissedMessages:function(ab,bb){bb=bb||da;p.trySend('/ajax/mercury/thread_sync.php',{last_action_id:w,folders:ab,client:bb});},fetchThreadData:function(ab,bb){bb=bb||da;n.allThreadID(ab);var cb={threads:{},client:bb},db=[],eb=[],fb=[];ab.forEach(function(hb){if(ba[hb])return;ba[hb]=true;var ib=ia(hb);if(ib){eb.push(ib);cb.threads.thread_ids=eb;}else{var jb=xa.tokenizeThreadID(hb);if(jb.type=='user'){db.push(jb.value);cb.threads.user_ids=db;}else if(jb.type=='group'){fb.push(jb.value);cb.threads.group_ids=fb;}else if(jb.type=='thread'){eb.push(jb.value);cb.threads.thread_ids=eb;}else if(jb.type!='root'&&jb.type!='email'&&jb.type!='pending')throw new Error('Unknown thread type',jb);}});xa.inform("fetch-thread-data",cb);for(var gb in cb.threads){p.trySend('/ajax/mercury/thread_info.php',cb);break;}},ensureThreadIsFetched:function(ab,bb){bb=bb||da;if(!y.getResource(ab)&&!ba[ab]){ba[ab]=true;p.trySend('/ajax/mercury/thread_info.php',{threads:{thread_ids:[ab]},client:bb});}},fetchThreadMessages:function(ab,bb,cb,db,eb){n.isThreadID(ab);eb=eb||da;var fb,gb,hb=xa.tokenizeThreadID(ab),ib=ia(ab),jb=false;if(ib&&hb.type!='group'){gb='thread_ids';fb=ib;}else{fb=hb.value;switch(hb.type){case 'user':gb='user_ids';jb=true;break;case 'group':gb='group_ids';break;case 'thread':gb='thread_ids';break;}}var kb={messages:{},threads:{},client:eb};if(gb){kb.messages[gb]={};kb.messages[gb][fb]={offset:bb,limit:cb};if(jb)kb.threads[gb]=[fb];p.trySend('/ajax/mercury/thread_info.php',kb,db);}else ha(ab,function(lb){kb.messages.thread_ids={};kb.messages.thread_ids[lb]={offset:bb,limit:cb};p.trySend('/ajax/mercury/thread_info.php',kb,db);});},handleThreadInfoError:function(ab){var bb=ab.getRequest().getData(),cb=[];if(bb.messages){for(var db in bb.messages.thread_ids)cb.push(ya(ka(db)));for(var eb in bb.messages.user_ids)cb.push(ya('user:'+eb));for(var fb in bb.messages.group_ids)cb.push(ya('group:'+fb));}if(cb.length)xa.handleUpdate({actions:cb,from_client:true,payload_source:u.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});if(bb.threads&&(bb.threads.user_ids||bb.threads.group_ids||bb.threads.thread_ids)&&!bb.is_retry){if(bb.messages)delete bb.messages;x.log('retry_thread',bb);bb.is_retry=true;p.trySend('/ajax/mercury/thread_info.php',bb);}},markFolderAsRead:function(ab){p.trySend('/ajax/mercury/mark_folder_as_read.php',{folder:ab});var bb=[{action_type:u.MercuryGlobalActionType.MARK_ALL_READ,action_id:null,folder:ab}];xa.handleUpdate({global_actions:bb,from_client:true,payload_source:u.MercuryPayloadSource.CLIENT_CHANGE_READ_STATUS});},changeThreadReadStatus:function(ab,bb,cb){n.isThreadID(ab);ha(ab,function(eb){var fb={ids:{}};fb.ids[eb]=bb;p.trySend('/ajax/mercury/change_read_status.php',fb);});var db=[{action_type:u.MercuryActionType.CHANGE_READ_STATUS,action_id:null,thread_id:ab,mark_as_read:bb,folder:cb}];xa.handleUpdate({actions:db,from_client:true,payload_source:u.MercuryPayloadSource.CLIENT_CHANGE_READ_STATUS});},changeThreadArchivedStatus:function(ab,bb){n.isThreadID(ab);ha(ab,function(eb){var fb={ids:{}};fb.ids[eb]=bb;p.trySend('/ajax/mercury/change_archived_status.php',fb);});var cb={action_type:u.MercuryActionType.CHANGE_ARCHIVED_STATUS,action_id:null,thread_id:ab,archived:bb},db={actions:[cb],from_client:true,payload_source:u.MercuryPayloadSource.CLIENT_CHANGE_ARCHIVED_STATUS};xa.handleUpdate(db);},changeThreadFolder:function(ab,bb){n.isThreadID(ab);ha(ab,function(eb){var fb={};fb[bb]=[eb];p.trySend('/ajax/mercury/move_thread.php',fb);});var cb={action_type:u.MercuryActionType.CHANGE_FOLDER,action_id:null,thread_id:ab,new_folder:bb},db={actions:[cb],from_client:true,payload_source:u.MercuryPayloadSource.CLIENT_CHANGE_FOLDER};xa.handleUpdate(db);},markThreadSpam:function(ab){n.isThreadID(ab);ha(ab,function(db){p.trySend('/ajax/mercury/mark_spam.php',{id:db});});var bb={action_type:u.MercuryActionType.CHANGE_FOLDER,action_id:null,thread_id:ab,new_folder:u.MessagingTag.SPAM},cb={actions:[bb],from_client:true,payload_source:u.MercuryPayloadSource.CLIENT_CHANGE_FOLDER};xa.handleUpdate(cb);},unmarkThreadSpam:function(ab){n.isThreadID(ab);ha(ab,function(db){p.trySend('/ajax/mercury/unmark_spam.php',{id:db});});var bb={action_type:u.MercuryActionType.CHANGE_FOLDER,action_id:null,thread_id:ab,new_folder:u.MessagingTag.INBOX},cb={actions:[bb],from_client:true,payload_source:u.MercuryPayloadSource.CLIENT_CHANGE_FOLDER};xa.handleUpdate(cb);},deleteThread:function(ab){n.isThreadID(ab);ha(ab,function(db){var eb={ids:[db]};p.trySend('/ajax/mercury/delete_thread.php',eb);});var bb={action_type:u.MercuryActionType.DELETE_THREAD,action_id:null,thread_id:ab},cb={actions:[bb],from_client:true,payload_source:u.MercuryPayloadSource.CLIENT_DELETE_THREAD};xa.handleUpdate(cb);},deleteMessages:function(ab,bb,cb){o.getServerIDs(bb||[],function(eb){p.trySend('/ajax/mercury/delete_messages.php',{message_ids:eb});});var db;if(cb){db={action_type:u.MercuryActionType.DELETE_THREAD,action_id:null,thread_id:ab};}else db={action_type:u.MercuryActionType.DELETE_MESSAGES,action_id:null,thread_id:ab,message_ids:bb};xa.handleUpdate({actions:[db],from_client:true,payload_source:u.MercuryPayloadSource.CLIENT_DELETE_MESSAGES});},clearChat:function(ab,bb,cb){n.isThreadID(ab);p.trySend('/ajax/chat/settings.php',{clear_history_id:bb});var db=[{action_type:u.MercuryActionType.CLEAR_CHAT,action_id:null,thread_id:ab,clear_time:cb}];xa.handleUpdate({actions:db,from_client:true,payload_source:u.MercuryPayloadSource.CLIENT_CLEAR_CHAT});},_batchThreadRead:function(ab,bb){var cb={};k(cb,ab.ids);k(cb,bb.ids);var db=ab.client||bb.client;return {ids:cb,client:db};},sendNewMessage:function(ab,bb){bb=bb||da;o.getServerIDs(ab.forward_message_ids||[],function(db){var eb=xa.tokenizeThreadID(ab.thread_id),fb=eb.type,gb=k({},ab);gb.forward_message_ids=db;if((fb=='root'&&eb.value==gb.message_id)||(fb=='user')||(ab.thread_id==v.PENDING_THREAD_ID)){gb.client_thread_id=gb.thread_id;gb.thread_id=null;xa._sendNewMessageToServer(gb,bb);}else ha(gb.thread_id,function(hb){gb.thread_id=hb;xa._sendNewMessageToServer(gb);});});if(ab.thread_id!=v.PENDING_THREAD_ID){var cb={actions:[k({},ab)],from_client:true,payload_source:u.MercuryPayloadSource.CLIENT_SEND_MESSAGE};xa.handleUpdate(cb);}},_sendNewMessageToServer:function(ab,bb){bb=bb||da;p.trySend('/ajax/mercury/send_messages.php',{message_batch:[ab],client:bb});},_batchMessageSend:function(ab,bb){var cb=ab.client||bb.client;return {client:cb,message_batch:ab.message_batch.concat(bb.message_batch)};},requestMessageConfirmation:function(ab,bb){bb=bb||da;var cb={},db={};for(var eb in ab){var fb=ia(eb);if(fb){cb[fb]=ab[eb];}else{var gb=ab[eb];for(var hb=0;hb<gb.length;hb++)db[gb[hb]]=eb;}}var ib=Object.keys(cb),jb=Object.keys(db);if(ib.length||jb.length)p.trySend('/ajax/mercury/confirm_messages.php',{thread_message_map:cb,local_messages:db,client:bb});},handleMessageConfirmError:function(ab){var bb=ab.getRequest().getData().thread_message_map,cb=ab.getRequest().getData().local_messages;if(!bb&&!cb)return;var db=[];for(var eb in bb){var fb=bb[eb];fb.forEach(function(ib){db.push({action_type:u.MercuryActionType.SEND_MESSAGE,client_message_id:ib,message_id:ib,client_thread_id:null,thread_id:eb,status:u.MercuryActionStatus.UNABLE_TO_CONFIRM});});}for(var gb in cb){var hb=cb[gb];db.push({action_type:u.MercuryActionType.SEND_MESSAGE,client_message_id:gb,message_id:gb,client_thread_id:hb,thread_id:null,status:u.MercuryActionStatus.UNABLE_TO_CONFIRM});}if(db.length)xa.handleUpdate({actions:db,payload_source:u.MercuryPayloadSource.CLIENT_HANDLE_ERROR});},markSeen:function(){var ab=j.convertActionIDToTimestamp(w);p.trySend('/ajax/mercury/mark_seen.php',{seen_timestamp:ab});},_batchMarkSeen:function(ab,bb){return bb;},handleRoger:function(ab){var bb=ab.tid?y.getResource(ab.tid):('user:'+ab.reader);if(bb){var cb={};cb[bb]={};cb[bb]['fbid:'+ab.reader]=ab.time;xa.inform('update-roger',cb);}},handleUpdateWaitForThread:function(ab,bb,cb){cb=cb||da;var db=y.getResource(bb);if(db){xa.handleUpdate(ab);return;}y.executeOrEnqueue(bb,function(){aa.push(ab);});if(!ba[bb]){ba[bb]=true;p.trySend('/ajax/mercury/thread_info.php',{threads:{thread_ids:[bb]},client:cb});}},handleUpdate:function(ab){x.debug('handle_update',{payload:ab,from_client:ab.from_client});for(var bb in ab){q.synchronizeInforms(function(){if(!ab.from_client){oa(ab);xa.inform('payload-preprocessed',ab);}xa.inform('update-thread-ids',ca);ca={};xa.inform('update-participants',ab);xa.inform('update-threads',ab);xa.inform('update-unread',ab);xa.inform('update-threadlist',ab);xa.inform('update-messages',ab);xa.inform('update-unseen',ab);xa.inform('update-typing-state',ab);xa.inform('update-roger',ab.roger);xa.inform('model-update-completed',null);pa();});break;}},_handleSendMessageErrorCommon:function(ab,bb){x.debug('handle_send_message_error_common',{response:ab,request_error_status:bb});var cb=ab.getPayload(),db=ab.getRequest().getData(),eb=db.message_batch;if(!eb){ma({action_type:u.MercuryActionType.SEND_MESSAGE,status:u.MercuryActionStatus.REQUEST_EMPTY_MESSAGE_LIST});return;}var fb,gb=null;if(cb&&cb.error_payload){fb=u.MercuryActionStatus.UNCONFIRMED;gb='send_error';}else{gb=bb==u.MercuryActionStatus.REQUEST_ERROR?'request_error':'transport_error';if(ab.getError())gb+='_'+ab.getError();fb=bb;}var hb=eb.map(function(jb){return {action_type:u.MercuryActionType.SEND_MESSAGE,client_message_id:jb.message_id,message_id:jb.message_id,client_thread_id:jb.client_thread_id,thread_id:jb.thread_id,status:fb};});hb.forEach(function(jb){ma(jb,gb);});var ib={actions:hb,payload_source:u.MercuryPayloadSource.CLIENT_HANDLE_ERROR};xa.handleUpdate(ib);},handleSendMessageError:function(ab){if(ab.error===1404074)h.verboseErrorHandler(ab);xa._handleSendMessageErrorCommon(ab,u.MercuryActionStatus.REQUEST_ERROR);},handleSendMessageTransportError:function(ab){xa._handleSendMessageErrorCommon(ab,u.MercuryActionStatus.TRANSPORT_ERROR);},getLastActionID:function(){return w;}});function ya(ab){return {action_type:u.MercuryActionType.LOG_MESSAGE,thread_id:ab,message_id:ab,timestamp:(new Date()).getTime(),timestamp_absolute:'',timestamp_relative:'',is_unread:false,source:u.MercurySourceType.UNKNOWN,log_message_type:u.MercuryLogMessageType.SERVER_ERROR,log_message_data:{}};}var za=xa.handleUpdate;p.registerEndpoints({'/ajax/mercury/thread_sync.php':{mode:p.IDEMPOTENT,handler:za},'/ajax/mercury/thread_info.php':{mode:p.BATCH_DEFERRED_MULTI,batch_function:qa,handler:za,error_handler:xa.handleThreadInfoError},'/ajax/mercury/mark_folder_as_read.php':{mode:p.IMMEDIATE,handler:za},'/ajax/mercury/change_read_status.php':{mode:p.BATCH_SUCCESSIVE,batch_function:xa._batchThreadRead,handler:za},'/ajax/mercury/send_messages.php':{mode:p.BATCH_SUCCESSIVE,batch_function:xa._batchMessageSend,handler:za,error_handler:xa.handleSendMessageError,transport_error_handler:xa.handleSendMessageTransportError},'/ajax/mercury/mark_seen.php':{mode:p.BATCH_SUCCESSIVE,batch_function:xa._batchMarkSeen,handler:za},'/ajax/mercury/confirm_messages.php':{mode:p.IMMEDIATE,handler:za,error_handler:xa.handleMessageConfirmError},'/ajax/mercury/threadlist_info.php':{mode:p.BATCH_SUCCESSIVE_UNIQUE,batch_function:sa,handler:za},'/ajax/mercury/mark_spam.php':{mode:p.IMMEDIATE,handler:za},'/ajax/mercury/unmark_spam.php':{mode:p.IMMEDIATE,handler:za},'/ajax/mercury/unread_threads.php':{mode:p.BATCH_SUCCESSIVE_UNIQUE,batch_function:ra,handler:za},'/ajax/chat/settings.php':{mode:p.IMMEDIATE},'/ajax/mercury/change_archived_status.php':{mode:p.BATCH_SUCCESSIVE,batch_function:ua,handler:za},'/ajax/mercury/delete_thread.php':{mode:p.BATCH_SUCCESSIVE,batch_function:wa,handler:za},'/ajax/mercury/delete_messages.php':{mode:p.IMMEDIATE,handler:za},'/ajax/mercury/move_thread.php':{mode:p.BATCH_SUCCESSIVE,batch_function:va,handler:za}});e.exports=xa;});
__d("MercuryParticipants",["Env","getObjectValues","MercuryAssert","MercuryIDs","ShortProfiles","MercuryServerRequests","copyProperties","tx","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Env'),h=b('getObjectValues'),i=b('MercuryAssert'),j=b('MercuryIDs'),k=b('ShortProfiles'),l=b('MercuryServerRequests'),m=b('copyProperties'),n=b('tx'),o=c('MercuryConstants'),p='fbid:'+g.user,q={},r={},s=function(w){w=u(w);if(!q[w.id]){q[w.id]=m({},w);if(w.vanity)r[w.vanity]=w.id;}};function t(w){i.isEmailParticipantID(w);var x=j.tokenize(w),y=x.value;return {gender:o.MercuryParticipantsConstants.UNKNOWN_GENDER,href:null,id:w,image_src:o.MercuryParticipantsConstants.EMAIL_IMAGE,name:y,short_name:y,employee:false,call_promo:false};}function u(w){var x=w.type===o.MercuryParticipantTypes.USER||w.type===o.MercuryParticipantTypes.FRIEND;if(!x)return w;if(!w.name&&!w.href&&!w.vanity){var y="Facebook User";w.name=y;w.short_name=y;}return w;}var v={user:p,getIDFromVanityOrFBID:function(w){if(!w)return;if(r[w])return r[w];if(w.match('^\\d+$'))return v.getIDForUser(w);},getNow:function(w){return q[w];},get:function(w,x){i.isParticipantID(w);v.getMulti([w],function(y){x(y[w]);});},getMulti:function(w,x){i.allParticipantIDs(w);var y={},z={};w.forEach(function(ba){if(q[ba]){y[ba]=m({},q[ba]);}else{var ca=j.tokenize(ba);if(ca.type=='fbid'){var da=ca.value;z[ba]=da;}else if(ca.type=='email')y[ba]=t(ba);}});var aa=h(z);if(aa.length){k.getMulti(aa,function(ba){for(var ca in z){var da=z[ca],ea=ba[da];y[ca]={gender:ea.gender,href:ea.uri,id:ca,image_src:ea.thumbSrc,name:ea.name,short_name:ea.firstName,employee:ea.employee,call_promo:ea.showVideoPromo,type:ea.type,vanity:ea.vanity};s(y[ca]);}x(y);});}else x(y);},getUserID:function(w){if(!j.isValid(w))return null;var x=j.tokenize(w);if(x.type!='fbid')return null;return x.value;},getIDForUser:function(w){return 'fbid:'+w;},addParticipants:function(w){w.forEach(s);}};l.subscribe('update-participants',function(w,x){v.addParticipants(x.participants||[]);});e.exports=v;});
__d("MercuryFolders",["array-extensions","MercuryConstants"],function(a,b,c,d,e,f){b('array-extensions');var g=c('MercuryConstants'),h=[g.MessagingTag.INBOX,g.MessagingTag.OTHER,g.MessagingTag.ACTION_ARCHIVED,g.MessagingTag.SPAM],i={getSupportedFolders:function(){return h.concat();},isSupportedFolder:function(j){return h.contains(j);},getFromMeta:function(j){var k=j.folder;if(j.is_archived)k=g.MessagingTag.ACTION_ARCHIVED;return k;}};e.exports=i;});
__d("MercuryAttachment",["startsWith","MercuryConstants"],function(a,b,c,d,e,f){var g=b('startsWith'),h=c('MercuryConstants'),i={getAttachIconClass:function(j){switch(j){case h.MercuryAttachmentContentType.PHOTO:return 'MercuryPhotoIcon';case h.MercuryAttachmentContentType.VIDEO:return 'MercuryVideoIcon';case h.MercuryAttachmentContentType.MUSIC:return 'MercuryMusicIcon';case h.MercuryAttachmentContentType.TEXT:return 'MercuryTextIcon';case h.MercuryAttachmentContentType.MSWORD:return 'MercuryMSWordIcon';case h.MercuryAttachmentContentType.MSXLS:return 'MercuryMSXLSIcon';case h.MercuryAttachmentContentType.MSPPT:return 'MercuryMSPPTIcon';}return 'MercuryDefaultIcon';},getAttachIconClassByMime:function(j){if(g(j,'image')){return 'MercuryPhotoIcon';}else if(g(j,'video')){return 'MercuryVideoIcon';}else if(g(j,'audio')){return 'MercuryMusicIcon';}else if(g(j,'text/plain')){return 'MercuryTextIcon';}else return 'MercuryDefaultIcon';},getAttachTypeByMime:function(j){if(g(j,'image')){return h.MercuryAttachmentContentType.PHOTO;}else if(g(j,'video')){return h.MercuryAttachmentContentType.VIDEO;}else if(g(j,'audio')){return h.MercuryAttachmentContentType.MUSIC;}else if(g(j,'text/plain')){return h.MercuryAttachmentContentType.TEXT;}else return h.MercuryAttachmentContentType.UNKNOWN;},convertRaw:function(j){var k=[];for(var l=0;l<j.length;l++){var m=j[l];if(m.filename){var n={};n.attach_type=h.MercuryAttachmentType.FILE;n.name=m.filename;n.icon_type=i.getAttachTypeByMime(m.filetype);n.url='#';k.push(n);}}return k;}};e.exports=i;});
__d("MercuryThreads",["Arbiter","copyProperties","JSLogger","createObjectFrom","KeyedCallbackManager","TimestampConverter","MercuryFolders","MercuryAssert","MercuryAttachment","MercuryIDs","MercuryServerRequests","MercuryThreadInformer","MercuryParticipants","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('JSLogger'),j=b('createObjectFrom'),k=b('KeyedCallbackManager'),l=b('TimestampConverter'),m=b('MercuryFolders'),n=b('MercuryAssert'),o=b('MercuryAttachment'),p=b('MercuryIDs'),q=b('MercuryServerRequests'),r=b('MercuryThreadInformer'),s=b('MercuryParticipants'),t=c('MercuryConstants'),u=i.create('mercury_threads'),v=new k();function w(ga,ha){var ia=j(ga.participants,true),ja=s.user;ha.forEach(function(ka){if(ia[ka]!==true){ga.participants.push(ka);if(ka===ja)ga.is_subscribed=true;}});}function x(ga,ha){ga.participants.remove(ha);if(ha===s.user)ga.is_subscribed=false;}function y(ga,ha){if(ga.participants[0]!=ha){ga.participants.remove(ha);ga.participants.unshift(ha);}}function z(ga,ha){var ia=ha.body,ja=ha.subject,ka='';if(ja){ja=ja.toLowerCase();if(ia.slice(0,ja.length).toLowerCase()==ja){ka=ia;}else if(ia){ka=ja+' \u00B7 '+ia;}else ka=ja;}else ka=ia;ga.snippet=ka;ga.snippet_has_attachment=ha.has_attachment;if(ha.raw_attachments&&ha.raw_attachments.length>0){var la=o.convertRaw(ha.raw_attachments);ga.snippet_attachments=la;}else ga.snippet_attachments=ha.attachments;ga.is_forwarded_snippet=!!ha.forward_count;}function aa(ga,ha){if(!ga)return false;var ia=!ga.unread_count;if(ha==ia)return false;ga.unread_count=ha?0:1;v.setResource(ga.thread_id,ga);r.updatedThread(ga.thread_id);return true;}function ba(ga){var ha=v.getAllResources();for(var ia in ha){var ja=ha[ia];if(ja.folder==ga){ja.unread_count=0;v.setResource(ia,ja);r.updatedThread(ia);}}}function ca(ga,ha){if(!ga||ga.chat_clear_time===ha)return false;ga.chat_clear_time=ha;v.setResource(ga.thread_id,ga);r.reorderedMessages(ga.thread_id);return true;}function da(ga,ha,ia){var ja=ha.action_type;if(ja==t.MercuryActionType.USER_GENERATED_MESSAGE||ja==t.MercuryActionType.LOG_MESSAGE){ha.is_unread&&ga.unread_count++;ga.is_archived=false;}switch(ja){case t.MercuryActionType.USER_GENERATED_MESSAGE:y(ga,ha.author);break;case t.MercuryActionType.LOG_MESSAGE:var ka=ha.log_message_type;if(ka==t.MercuryLogMessageType.SUBSCRIBE){w(ga,ha.log_message_data.added_participants);}else if(ka==t.MercuryLogMessageType.UNSUBSCRIBE){x(ga,ha.author);}else if(ka==t.MercuryLogMessageType.THREAD_IMAGE){ga.image_src=ha.log_message_data.image?ha.log_message_data.image.preview_url:null;}else if(ka==t.MercuryLogMessageType.THREAD_NAME)ga.name=ha.log_message_data.name;break;case t.MercuryActionType.CHANGE_READ_STATUS:if(ha.timestamp)r.changedThreadReadState(ga.thread_id,ha.mark_as_read,ha.timestamp);aa(ga,ha.mark_as_read);break;case t.MercuryActionType.CLEAR_CHAT:ca(ga,ha.clear_time);break;case t.MercuryActionType.CHANGE_ARCHIVED_STATUS:ga.is_archived=ha.archived;break;case t.MercuryActionType.CHANGE_FOLDER:ga.folder=ha.new_folder;break;case t.MercuryActionType.DELETE_MESSAGES:if(ia){ga.snippet='...';ga.snippet_has_attachment=false;ga.snippet_attachments=null;ga.is_forwarded_snippet=false;r.updatedThread(ha.thread_id);}break;}if(ha.action_id)ga.last_action_id=l.maxValidActionID(ha.action_id,ga.last_action_id);}function ea(ga){var ha=q.tokenizeThreadID(ga.thread_id);if(ha.type=='group'){u.error('invalid_new_thread_message',ga);return undefined;}var ia={thread_id:ga.thread_id,last_action_id:ga.action_id,participants:ga.specific_to_list,name:null,snippet:ga.body,snippet_has_attachment:false,snippet_attachments:[],unread_count:0,image_src:null,timestamp_absolute:ga.timestamp_absolute,timestamp_relative:ga.timestamp_relative,timestamp:ga.timestamp,is_canonical_user:ha.type=='user',is_canonical:ha.type=='user'||ha.type=='email',is_subscribed:true,root_message_threading_id:ga.message_id,folder:t.MessagingTag.INBOX,is_archived:false,mode:t.MercuryThreadMode.TITAN_ORIGINATED};v.setResource(ia.thread_id,ia);return ia;}g.subscribe(i.DUMP_EVENT,function(ga,ha){ha.messaging=ha.messaging||{};ha.messaging.threads=v.dumpResources();});var fa={getThreadMetaNow:function(ga){n.isThreadID(ga);return v.getResource(ga);},getThreadMeta:function(ga,ha,ia){n.isThreadID(ga);var ja=v.executeOrEnqueue(ga,ha),ka=v.getUnavailableResources(ja);if(ka.length){var la=q.tokenizeThreadID(ga);if(la.type=='user'){fa.getCanonicalThreadToUser(la.value);}else q.fetchThreadData(ka,ia);}return ja;},unsubscribe:function(ga){v.unsubscribe(ga);},changeThreadReadStatus:function(ga,ha){n.isThreadID(ga);var ia=v.getResource(ga);if(aa(ia,ha))q.changeThreadReadStatus(ga,ha,m.getFromMeta(ia));},changeThreadArchivedStatus:function(ga,ha){n.isThreadID(ga);var ia=v.getResource(ga);if(ia.is_archived!=ha){ia.is_archived=ha;r.updatedThread(ia.thread_id);q.changeThreadArchivedStatus(ga,ha);}},markThreadSpam:function(ga){q.markThreadSpam(ga);},unmarkThreadSpam:function(ga){q.unmarkThreadSpam(ga);},changeFolder:function(ga,ha){n.isThreadID(ga);var ia=v.getResource(ga);if(ia&&ia.folder!=ha){ia.folder=ha;r.updatedThread(ia.thread_id);q.changeThreadFolder(ga,ha);}},deleteThread:function(ga){n.isThreadID(ga);q.deleteThread(ga);},updateThreads:function(ga){if(!ga||!ga.length)return;var ha={};ga.forEach(function(ia){ha[ia.thread_id]=ia;});v.addResourcesAndExecute(ha);},updateMetadataByActions:function(ga,ha){if(!ga||!ga.length)return;var ia={},ja={},ka={};for(var la=0;la<ga.length;la++){var ma=ga[la];if(ma.is_forward)continue;var na=ma.action_type,oa=ma.thread_id;n.isThreadID(oa);var pa=fa.getThreadMetaNow(oa);if(na==t.MercuryActionType.LOG_MESSAGE&&ma.log_message_type==t.MercuryLogMessageType.SERVER_ERROR)continue;if(!pa&&!ma.action_id&&na==t.MercuryActionType.USER_GENERATED_MESSAGE)pa=ea(ma);if(pa){if(na==t.MercuryActionType.DELETE_THREAD){r.deletedThread(oa);continue;}var qa=!!ma.action_id;if(na==t.MercuryActionType.LOG_MESSAGE||na==t.MercuryActionType.USER_GENERATED_MESSAGE)qa=!ha;if(ma.timestamp<=pa.timestamp&&qa){u.log('ignore_old_timestamp',{action:ma,from_client:ha,thread_timestamp:pa.timestamp});continue;}if(!ka[oa])ka[oa]=h({},pa);da(ka[oa],ma,ha);if(na==t.MercuryActionType.USER_GENERATED_MESSAGE)ia[oa]=ma;if(na==t.MercuryActionType.USER_GENERATED_MESSAGE||na==t.MercuryActionType.LOG_MESSAGE||na==t.MercuryActionType.SEND_MESSAGE)if(ma&&ma.timestamp&&(!ja[oa]||ma.timestamp>ja[oa].timestamp))ja[oa]=ma;}}for(var ra in ka){var sa=ka[ra],ta=ia[ra];if(ta)z(sa,ta);var ua=ja[ra],va=sa.timestamp;if(ua&&ua.timestamp>va)sa=h(sa,{timestamp_absolute:ua.timestamp_absolute,timestamp_relative:ua.timestamp_relative,timestamp:ua.timestamp});v.setResource(ra,sa);}},getCanonicalThreadToUser:function(ga,ha,ia){return fa.getCanonicalThreadToParticipant('fbid:'+ga,ha,ia);},getCanonicalThreadToParticipant:function(ga,ha,ia){var ja=fa.getThreadIDForParticipant(ga),ka=v.getResource(ja);if(typeof ka=='undefined'){ka=fa.createNewLocalThread(ja,[s.user,ga],ha);q.fetchThreadData([ja],ia);}return ka;},getThreadIdForUser:function(ga){return 'user:'+ga;},getThreadIdForEmail:function(ga){return 'email:'+ga;},getThreadIDForParticipant:function(ga){var ha=p.tokenize(ga);return ha.type=='fbid'?fa.getThreadIdForUser(ha.value):fa.getThreadIdForEmail(ha.value);},createNewLocalThread:function(ga,ha,ia){var ja=v.getResource(ga);if(!ja){var ka=q.tokenizeThreadID(ga);ja={thread_id:ga,last_action_id:null,participants:ha,name:null,snippet:'',snippet_has_attachment:false,unread_count:ia?ia:0,image_src:null,timestamp_absolute:null,timestamp_relative:null,timestamp:null,is_canonical_user:ka.type=='user',is_canonical:ka.type=='user'||ka.type=='email',is_subscribed:true,root_message_threading_id:null,folder:t.MessagingTag.INBOX,is_archived:false,mode:t.MercuryThreadMode.TITAN_ORIGINATED};v.setResource(ga,ja);}return ja;},addParticipantsToThreadLocally:function(ga,ha){var ia=v.getResource(ga);if(ia){w(ia,ha);r.updatedThread(ia.thread_id);}},getCanonicalUserInThread:function(ga){var ha=q.tokenizeThreadID(ga);return ha.type=='user'?ha.value:null;},getCanonicalGroupInThread:function(ga){var ha=q.tokenizeThreadID(ga);return ha.type=='group'?ha.value:null;},isEmptyLocalThread:function(ga){var ha=v.getResource(ga);if(!ha)return false;var ia=q.tokenizeThreadID(ga);return ia.type=='root'&&!ha.timestamp;},isMultichatThread:function(ga){var ha=q.tokenizeThreadID(ga).type;return ha!='user'&&ha!='group'&&ha!='email';}};q.subscribe('update-threads',function(ga,ha){var ia=(ha.actions||[]).filter(function(ma){return ma.thread_id;});fa.updateThreads(ha.threads);fa.updateMetadataByActions(ia,ha.from_client);(ha.threads||[]).forEach(function(ma){r.updatedThread(ma.thread_id);});var ja=ha.global_actions||[];for(var ka=0;ka<ja.length;ka++){var la=ja[ka];if(la.action_type==t.MercuryGlobalActionType.MARK_ALL_READ)ba(la.folder);}});e.exports=fa;});
__d("MercuryChannelHandler",["Arbiter","ChannelConstants","copyProperties","Env","MessagingReliabilityLogger","MercuryParticipants","PresenceUtil","MercuryServerRequests","MercuryThreadInformer","MercuryThreads","MercuryConstants","MercuryConfig"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ChannelConstants'),i=b('copyProperties'),j=b('Env'),k=b('MessagingReliabilityLogger'),l=b('MercuryParticipants'),m=b('PresenceUtil'),n=b('MercuryServerRequests'),o=b('MercuryThreadInformer'),p=b('MercuryThreads'),q=c('MercuryConstants'),r=c('MercuryConfig');function s(ha,ia){if(ha!=h.getArbiterType('messaging')||!ia.obj||!ia.obj.message){k.addEntry('channel_receive','invalid_data');return;}var ja=ia.obj.message,ka={author:ja.mercury_author_id,author_email:ja.mercury_author_email,body:ja.body,subject:ja.subject,has_attachment:ja.has_attachment,attachments:ja.attachments,html_body:ja.html_body,thread_id:ja.tid,message_id:ja.mid,coordinates:ja.mercury_coordinates,spoof_warning:ja.mercury_spoof_warning,source:ja.mercury_source,source_tags:ja.mercury_source_tags,threading_id:ja.threading_id,timestamp:ja.timestamp,timestamp_absolute:ja.timestamp_absolute,timestamp_relative:ja.timestamp_relative,action_type:q.MercuryActionType.USER_GENERATED_MESSAGE,is_unread:ja.is_unread,action_id:ja.action_id,is_forward:false,forward_count:ja.forward_count||ja.forward,forward_message_ids:ja.forward_msg_ids,location_text:ja.location_text,folder:ia.obj.folder},la=[i({},ka)];la=la.concat(ja.forward_actions||[]);var ma=q.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE;n.handleUpdateWaitForThread({actions:la,payload_source:ma},ja.tid);if(!ja.is_unread&&ja.mercury_author_id===l.user){var na={};na[ja.tid]=ia.obj.folder;t(h.getArbiterType('messaging'),{obj:{event:q.MessagingEventTypes.READ,tids:[ja.tid],folder_info:na}});}k.addEntry('channel_receive','success',[ka.thread_id,ka.message_id,m.getSessionID()]);}function t(ha,ia){if(ha!=h.getArbiterType('messaging')||!ia.obj||!ia.obj.tids)return;var ja=[],ka=ia.obj.event==q.MessagingEventTypes.READ;ia.obj.tids.forEach(function(la){ja.push({action_type:q.MercuryActionType.CHANGE_READ_STATUS,action_id:null,thread_id:la,mark_as_read:ka,timestamp:ia.obj.timestamp||0,folder:ia.obj.folder_info[la]});});n.handleUpdate({actions:ja,payload_source:q.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});}function u(ha,ia){if(ha!=h.getArbiterType('messaging')||!ia.obj||!ia.obj.tids)return;var ja=[];ia.obj.tids.forEach(function(ka){ja.push({action_type:q.MercuryActionType.DELETE_THREAD,action_id:null,thread_id:ka});});n.handleUpdate({actions:ja,payload_source:q.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});}function v(ha,ia){if(ha!=h.getArbiterType('messaging')||!ia.obj||!ia.obj.tids||!ia.obj.mids)return;var ja=ia.obj.tids[0],ka={action_type:q.MercuryActionType.DELETE_MESSAGES,action_id:null,thread_id:ja,message_ids:ia.obj.mids};n.handleUpdate({actions:[ka],threads:[ia.obj.updated_thread],payload_source:q.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});}function w(ha,ia){if(ha!=h.getArbiterType('messaging')||!ia.obj||!ia.obj.folder)return;var ja={action_type:q.MercuryGlobalActionType.MARK_ALL_READ,action_id:ia.obj.action_id,folder:ia.obj.folder};n.handleUpdate({global_actions:[ja]});}function x(ha,ia){if(ha!=h.getArbiterType('messaging')||!ia.obj.tids)return;var ja=q.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE;ia.obj.tids.forEach(function(ka){var la={action_type:q.MercuryActionType.CHANGE_ARCHIVED_STATUS,action_id:null,thread_id:ka,archived:ia.obj.state};n.handleUpdateWaitForThread({actions:[i({},la)],payload_source:ja},ka);});}function y(ha,ia){if(ha!=h.getArbiterType('messaging')||!ia.obj.tids)return;var ja=q.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE,ka;ia.obj.tids.forEach(function(la){if(ia.obj.event==q.MessagingEventTypes.TAG){ka=ia.obj.tag;}else ka=ia.obj.marked_as_spam?q.MessagingTag.SPAM:q.MessagingTag.INBOX;var ma={action_type:q.MercuryActionType.CHANGE_FOLDER,action_id:null,thread_id:la,new_folder:ka};n.handleUpdateWaitForThread({actions:[i({},ma)],payload_source:ja},la);});}function z(ha,ia){if(ha!=h.getArbiterType('messaging')||!ia.obj.tag)return;switch(ia.obj.tag){case q.MessagingTag.ACTION_ARCHIVED:x(ha,ia);break;case q.MessagingTag.INBOX:case q.MessagingTag.OTHER:y(ha,ia);break;}}function aa(ha,ia,ja){return ha+':'+ia+':'+ja;}function ba(ha,ia){if(ha!=h.getArbiterType('inbox')||!ia.obj||!ia.obj.seen_timestamp)return;n.handleUpdate({message_counts:[{seen_timestamp:ia.obj.seen_timestamp,folder:q.MessagingTag.INBOX}],unseen_thread_ids:[{thread_ids:[],folder:q.MessagingTag.INBOX}],payload_source:q.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});}function ca(ha,ia){if(ha!=h.getArbiterType('mercury')||!ia.obj)return;o.synchronizeInforms(function(){var ja=ia.obj,ka=[];(ja.actions||[]).forEach(function(la){var ma=q.MercuryActionType.USER_GENERATED_MESSAGE;if(la.action_type==q.MercuryActionType.LOG_MESSAGE){var na=q.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE;n.handleUpdateWaitForThread({actions:[i({},la)],payload_source:na},la.thread_id);}else if(la.action_type!=ma)ka.push(la);});ja.actions=ka;ja.payload_source=q.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE;n.handleUpdate(ja);});}function da(ha,ia){n.handleRoger(ia.obj);}function ea(ha,ia){switch(ia.obj.event){case q.MessagingEventTypes.DELIVER:s(ha,ia);break;case q.MessagingEventTypes.READ:case q.MessagingEventTypes.UNREAD:t(ha,ia);break;case q.MessagingEventTypes.READ_ALL:w(ha,ia);break;case q.MessagingEventTypes.DELETE:u(ha,ia);break;case q.MessagingEventTypes.DELETE_MESSAGES:v(ha,ia);break;case q.MessagingEventTypes.TAG:z(ha,ia);break;case q.MessagingEventTypes.REPORT_SPAM:y(ha,ia);break;case q.MessagingEventTypes.READ_RECEIPT:da(ha,ia);break;}}var fa=[],ga={turnOn:function(){if(!fa.length){var ha={mercury:ca,messaging:ea,inbox:ba};for(var ia in ha)fa.push(g.subscribe(h.getArbiterType(ia),ha[ia]));}},turnOff:function(){if(fa.length){fa.forEach(g.unsubscribe);fa=[];}}};ga.turnOn();e.exports=ga;});
__d("MercuryUnseenState",["Arbiter","copyProperties","TimestampConverter","KeyedCallbackManager","JSLogger","createObjectFrom","MercuryServerRequests","MercuryThreadInformer","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('TimestampConverter'),j=b('KeyedCallbackManager'),k=b('JSLogger'),l=b('createObjectFrom'),m=b('MercuryServerRequests'),n=b('MercuryThreadInformer'),o=c('MercuryConstants'),p=o.MercuryThreadlistConstants.MAX_UNSEEN_COUNT,q=0,r=0,s=false,t=new j(),u='unseen_thread_hash',v='unseen_thread_list',w=k.create('mercury_unseen_state'),x={getUnseenCount:function(){if(x.exceedsMaxCount()){w.error('unguarded_unseen_count_fetch',{});return 0;}return ba();},exceedsMaxCount:function(){return s||(ba()>p);},markAsSeen:function(){if(ba()>0||s){m.markSeen();da(i.convertActionIDToTimestamp(m.getLastActionID()),[]);}},markThreadSeen:function(ka,la){var ma={};ma[ka]=null;fa(ma,la);}};function y(ka){t.setResource(u,ka);t.setResource(v,Object.keys(ka));}function z(ka){var la=t.executeOrEnqueue(u,ka),ma=t.getUnavailableResources(la);if(ma.length)m.fetchUnseenThreadIDs();}function aa(){return t.getResource(u);}function ba(){var ka=t.getResource(v);if(ka){return ka.length;}else return q;}function ca(ka){var la=ja(ka);if(ka.unseen_thread_ids){ka.unseen_thread_ids.forEach(function(wa){if(wa.folder!=o.MessagingTag.INBOX)return;var xa=ha(wa.thread_ids),ya=r;if(la&&la.seen_timestamp)ya=la.seen_timestamp;da(ya,xa);if(la&&la.unseen_count>p)s=true;});}else if(la&&la.seen_timestamp){r=la.seen_timestamp;if(la.unseen_count>p){s=true;y({});}else{q=la.unseen_count;if(q===0)y({});}}else{if(s)return;var ma=ka.actions;if(!ma||!(ma.length))return;var na={},oa={};for(var pa=0;pa<ma.length;pa++){var qa=ma[pa];if(qa.is_forward)continue;var ra=qa.action_type,sa=qa.action_id,ta=qa.thread_id?qa.thread_id:qa.server_thread_id,ua=qa.folder===undefined||qa.folder==o.MessagingTag.INBOX;if(!ua)continue;if(ra==o.MercuryActionType.USER_GENERATED_MESSAGE||ra==o.MercuryActionType.LOG_MESSAGE){var va=i.isGreaterThan(sa,na[ta]);if(qa.is_unread&&(!na[ta]||va))na[ta]=sa;}else if(ra==o.MercuryActionType.CHANGE_READ_STATUS&&qa.mark_as_read)oa[ta]=sa;}ea(na);fa(oa);}}function da(ka,la){var ma=aa();if(ma===undefined||ka>r||s){r=ka;la=la||[];if(la.length<=p)s=false;var na={},oa=aa()||{};for(var pa in oa)if(oa[pa]!==true){var qa=oa[pa];if(ga(qa))na[pa]=qa;}var ra=h(l(la,true),na);y(ra);n.updatedUnseenState();}}function ea(ka){if(s)return;var la={},ma=false;for(var na in ka){var oa=ka[na];if(ga(oa)){la[na]=oa;ma=true;}}if(!ma)return;z(function(pa){for(var qa in la){var ra=la[qa];if(!pa[qa]&&ga(ra))pa[qa]=la[qa];}y(pa);n.updatedUnseenState();});}function fa(ka,la){var ma=false;for(var na in ka){ma=true;break;}if(ma)z(function(oa){var pa=false;for(var qa in ka){var ra=ka[qa],sa=i.isGreaterThan(ra,oa[qa]);if(oa[qa]&&(!ra||sa)){delete oa[qa];pa=true;}}if(pa){y(oa);n.updatedUnseenState();if(la&&ba()===0)m.markSeen();}});}function ga(ka){return i.convertActionIDToTimestamp(ka)>r;}function ha(ka){return ka.map(m.convertThreadIDIfAvailable);}function ia(ka){var la=aa();if(!la)return;for(var ma in ka){var na=ka[ma];if(la[ma]){la[na]=la[ma];delete la[ma];}}y(la);}function ja(ka){var la=(ka.message_counts||[]);for(var ma=0;ma<la.length;ma++)if(la[ma].folder==o.MessagingTag.INBOX)return la[ma];return null;}m.subscribe('update-unseen',function(ka,la){ca(la);});m.subscribe('update-thread-ids',function(ka,la){ia(la);});g.subscribe(k.DUMP_EVENT,function(ka,la){la.messaging=la.messaging||{};la.messaging.unseen=h({},aa());la.messaging.unseen_max_count=s;la.messaging.unseen_time=r;});e.exports=x;});
__d("MercuryJewelCountControl",["Arbiter","DOM","JewelX","MercuryUnseenState","MercuryServerRequests","MercuryThreadInformer","copyProperties","tx","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=c('MercuryConstants'),i=b('DOM'),j=b('JewelX'),k=b('MercuryUnseenState'),l=b('MercuryServerRequests'),m=b('MercuryThreadInformer'),n=b('copyProperties'),o=b('tx'),p,q,r,s=function(u){if(u||r.isOpen())k.markAsSeen();},t=function(u,v){p=u;q=i.find(p,'#mercurymessagesCountValue');r=v;this.render();l.subscribe('model-update-completed',function(w,x){s(false);});m.subscribe('unseen-updated',this.render.bind(this));r.subscribe('marked-seen',s.shield(this,true));};n(t.prototype,{render:function(){var u='';if(k.exceedsMaxCount()){u=o._("{count}+",{count:h.MercuryThreadlistConstants.MAX_UNSEEN_COUNT});}else u=k.getUnseenCount().toString();g.inform('jewel/count-updated',{jewel:'mercurymessages',count:u},g.BEHAVIOR_STATE);}});e.exports=t;});
__d("MercuryFilters",["array-extensions","MercuryConstants"],function(a,b,c,d,e,f){b('array-extensions');var g=c('MercuryConstants'),h=[g.MessagingTag.UNREAD],i={ALL:'all',getSupportedFilters:function(){return h.concat();},isSupportedFilter:function(j){return h.contains(j);}};e.exports=i;});
__d("MercuryOrderedThreadlist",["JSLogger","MercuryFolders","MercuryFilters","MercuryServerRequests","RangedCallbackManager","MercuryThreadInformer","MercuryThreads","MercuryConstants"],function(a,b,c,d,e,f){var g=b('JSLogger'),h=b('MercuryFolders'),i=b('MercuryFilters'),j=b('MercuryServerRequests'),k=b('RangedCallbackManager'),l=b('MercuryThreadInformer'),m=b('MercuryThreads'),n=c('MercuryConstants'),o=g.create('ordered_threadlist_model'),p=i.getSupportedFilters().concat([i.ALL]),q=h.getSupportedFolders(),r={};q.forEach(function(ca){r[ca]={};p.forEach(function(da){r[ca][da]=new k(function(ea){return m.getThreadMetaNow(ea).timestamp;},function(ea,fa){return fa-ea;},j.canLinkExternally.bind(j));});});function s(ca,da,ea){var fa=[],ga=false,ha=false,ia=(ca||[]).filter(function(pa){var qa=pa.filter||i.ALL;return (pa.folder==da||(!pa.folder&&da==n.MessagingTag.INBOX))&&qa==ea;}),ja=r[da][ea].getAllResources(),ka;ia.forEach(function(pa){fa=fa.concat(pa.thread_ids);if(pa.error){if(pa.end>ja.length)ha=pa.error;}else{var qa=pa.end-pa.start;if(pa.thread_ids.length<qa)ga=true;}if(!ka||pa.end>ka)ka=pa.end;});w(fa,da,ea);if(ga){r[da][ea].setReachedEndOfArray();}else if(ha){r[da][ea].setError(ha);}else{var la=r[da][ea].getCurrentArraySize();if(ka&&la<ka){var ma={},na=ja.concat(fa),oa=na.filter(function(pa){var qa=ma[pa];ma[pa]=true;return qa;});if(oa.length){o.warn('duplicate_threads',{folder:da,expected_final_size:ka,actual_final_size:la,duplicate_thread_ids:oa});j.fetchThreadlistInfo(ka,oa.length,da,ea==i.ALL?null:ea);}}}}function t(ca){q.forEach(function(da){p.forEach(function(ea){s(ca,da,ea);});});}function u(ca){var da={};q.forEach(function(ea){da[ea]={};p.forEach(function(fa){da[ea][fa]={to_add:[],to_remove:[],to_remove_if_last_after_add:{}};});});ca.forEach(function(ea){if(ea.is_forward)return;var fa=ea.thread_id,ga=x(fa),ha=y(fa);function ia(){ha.forEach(function(ka){da[ga][ka].to_add.push(fa);if(!r[ga][ka].hasReachedEndOfArray()&&!r[ga][ka].hasResource(fa))da[ga][ka].to_remove_if_last_after_add[fa]=true;});}function ja(ka){if(p.contains(ka))if(ha.contains(ka)){da[ga][ka].to_add.push(fa);}else da[ga][ka].to_remove.push(fa);}if(!ga){if(ea.action_type===n.MercuryActionType.CHANGE_FOLDER||ea.action_type===n.MercuryActionType.CHANGE_ARCHIVED_STATUS)q.forEach(function(ka){if(ka!==ga)p.forEach(function(la){r[ka][la].removeResources([fa]);});});return;}switch(ea.action_type){case n.MercuryActionType.DELETE_THREAD:ha.forEach(function(ka){da[ga][ka].to_remove.push(fa);});break;case n.MercuryActionType.CHANGE_ARCHIVED_STATUS:case n.MercuryActionType.CHANGE_FOLDER:ia();break;case n.MercuryActionType.CHANGE_READ_STATUS:ja(n.MessagingTag.UNREAD);break;case n.MercuryActionType.USER_GENERATED_MESSAGE:case n.MercuryActionType.LOG_MESSAGE:ha.forEach(function(ka){if(z(fa,ga,ka))da[ga][ka].to_add.push(fa);});break;}});q.forEach(function(ea){p.forEach(function(fa){var ga=r[ea][fa];w(da[ea][fa].to_add,ea,fa);for(var ha=ga.getCurrentArraySize()-1;ha>=0;ha--){var ia=ga.getResourceAtIndex(ha);if(!da[ea][fa].to_remove_if_last_after_add[ia])break;da[ea][fa].to_remove.push(ia);}ga.removeResources(da[ea][fa].to_remove);});});}function v(ca){var da={};q.forEach(function(ea){da[ea]={};p.forEach(function(fa){da[ea][fa]=[];});});ca.forEach(function(ea){var fa=x(ea.thread_id),ga=y(ea.thread_id);ga.forEach(function(ha){if(fa&&z(ea.thread_id,fa,ha))da[fa][ha].push(ea.thread_id);});});q.forEach(function(ea){p.forEach(function(fa){if(da[ea][fa].length>0)w(da[ea][fa],ea,fa);});});}function w(ca,da,ea){ea=ea||i.ALL;r[da][ea].addResources(ca);q.forEach(function(fa){if(fa!=da)r[fa][ea].removeResources(ca);});}function x(ca){var da=m.getThreadMetaNow(ca),ea=null;if(!da){ea='No thread metadata';}else if(!da.folder)ea='No thread folder';if(ea){var fa={error:ea,tid:ca};o.warn('no_thread_folder',fa);return null;}var ga=da.folder;if(da.is_archived)ga=n.MessagingTag.ACTION_ARCHIVED;if(r[ga]){return ga;}else return null;}function y(ca){var da=m.getThreadMetaNow(ca),ea=[i.ALL];if(!da){var fa={error:'no_thread_metadata',tid:ca};o.warn('no_thread_metadata',fa);return [];}if(da.unread_count)ea.push(n.MessagingTag.UNREAD);return ea;}function z(ca,da,ea){var fa=m.getThreadMetaNow(ca);return fa&&fa.timestamp&&x(ca)==da&&y(ca).contains(ea);}var aa={getThreadlist:function(ca,da,ea,fa,ga,ha){return aa.getFilteredThreadlist(ca,da,ea,i.ALL,fa,ga,ha);},getFilteredThreadlist:function(ca,da,ea,fa,ga,ha,ia){var ja=r[ea][fa],ka=ja.executeOrEnqueue(ca,da,ga,ha),la=ja.getUnavailableResources(ka);if(la.length){if(ja.getCurrentArraySize()<ca){var ma={start:ca,limit:da,filter:fa,resources_size:ja.getCurrentArraySize()};o.warn('range_with_gap',ma);}j.fetchThreadlistInfo(ja.getCurrentArraySize(),la.length,ea,fa==i.ALL?null:fa,ia);}return ka;},getThreadlistUntilTimestamp:function(ca,da,ea){ea=ea||i.ALL;return r[da][ea].getElementsUntil(ca);},unsubscribe:function(ca,da,ea){ea=ea||i.ALL;r[da][ea].unsubscribe(ca);}};function ba(ca){switch(ca.payload_source){case n.MercuryPayloadSource.CLIENT_CHANGE_ARCHIVED_STATUS:case n.MercuryPayloadSource.CLIENT_CHANGE_READ_STATUS:case n.MercuryPayloadSource.CLIENT_CHANGE_FOLDER:case n.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE:case n.MercuryPayloadSource.CLIENT_DELETE_MESSAGES:case n.MercuryPayloadSource.CLIENT_DELETE_THREAD:case n.MercuryPayloadSource.CLIENT_SEND_MESSAGE:case n.MercuryPayloadSource.SERVER_SEND_MESSAGE:case n.MercuryPayloadSource.SERVER_CONFIRM_MESSAGES:case n.MercuryPayloadSource.SERVER_FETCH_THREADLIST_INFO:case n.MercuryPayloadSource.SERVER_THREAD_SYNC:return true;case n.MercuryPayloadSource.SERVER_INITIAL_DATA:return ca.ordered_threadlists;default:return false;}}j.subscribe('update-threadlist',function(ca,da){if(!ba(da))return;var ea=da.ordered_threadlists;if(ea&&ea.length){t(ea);}else{var fa=(da.actions||[]).filter(function(ga){return ga.thread_id;});v(da.threads||[]);u(fa);}l.updatedThreadlist();});e.exports=aa;});
__d("MercuryEmoji",["Emoji","Emote","MercuryConfig"],function(a,b,c,d,e,f){var g=b('Emoji'),h=b('Emote'),i=c('MercuryConfig'),j={htmlEmojiAndEmote:function(k,l){if(i.MessagingDisplayEmojiGK){return g.htmlEmojiAndEmote(k,l);}else return h.htmlEmote(k,l);}};e.exports=j;});
__d("WebMessengerPermalinkConstants",["URI"],function(a,b,c,d,e,f){var g=b('URI'),h={ARCHIVED_PATH:'/messages/archived',BASE_PATH:'/messages',OTHER_PATH:'/messages/other',SPAM_PATH:'/messages/spam',COMPOSE_POSTFIX_PATH:'/new',SEARCH_POSTFIX_PATH:'/search',TID_POSTFIX_PARTIAL_PATH:'/conversation-',overriddenVanities:'(archived|other|spam|new|search|conversation-.*)',getURIPathForThreadID:function(i,j){return (j||h.BASE_PATH)+h.TID_POSTFIX_PARTIAL_PATH+g.encodeComponent(g.encodeComponent(i));},getThreadIDFromURI:function(i){var j=i.getPath().match(h.BASE_PATH+'(/[^/]*)*'+h.TID_POSTFIX_PARTIAL_PATH+'([^/]+)');if(j){var k=g.decodeComponent(g.decodeComponent(j[2]));return k;}},getURIPathForIDOrVanity:function(i,j){if(i.match('^'+h.overriddenVanities+'$'))i='.'+i;return (j||h.BASE_PATH)+'/'+i;},getUserIDOrVanity:function(i){var j=i.match(h.BASE_PATH+'.*/([^/]+)/?$'),k=j&&j[1],l=h.overriddenVanities;if(!k||k.match('^'+l+'$')){return false;}else if(k.match('^\\.'+l+'$')){return k.substr(1);}else return k;}};e.exports=h;});
__d("MercuryThreadMetadataRawRenderer",["event-extensions","CSS","DOM","Tooltip","URI","WebMessengerPermalinkConstants","tx","MercuryConfig","MercuryConstants","MercuryStatusTemplates"],function(a,b,c,d,e,f){b('event-extensions');var g=b('CSS'),h=b('DOM'),i=b('Tooltip'),j=b('URI'),k=b('WebMessengerPermalinkConstants'),l=b('tx'),m=c('MercuryConfig'),n=c('MercuryConstants'),o=c('MercuryStatusTemplates');e.exports={renderParticipantListWithNoThreadName:function(p,q,r,s,t,u){var v={callback:true,check_length:true,show_unread_count:true};u=u||{};var w={};for(var x in u)if(v[x]){w[x]=u[x];delete u[x];}var y=r.map(function(da){return s[da];}),z=this.renderRawParticipantList(p,y,r.length,u);z=this.renderRawTitleWithUnreadCount(z,w.show_unread_count?q.unread_count:0);var aa=u.abbr_mode,ba={};for(var ca in u)ba[ca]=u[ca];ba.abbr_mode=true;t.forEach(function(da){var ea=t.length>1?this._cloneIfDOMElement(z):z;h.setContent(da,ea);if(w.check_length&&!aa&&da.scrollWidth>da.clientWidth){var fa=this.renderRawParticipantList(p,y,r.length,ba),ga=this.renderRawTitleWithUnreadCount(fa,w.show_unread_count?q.unread_count:0);h.setContent(da,ga);}}.bind(this));w.callback&&w.callback(z);},renderRawParticipantList:function(p,q,r,s){var t={abbr_mode:true,last_separator_uses_and:true,link_mode:true,names_renderer:true};s=s||{};var u=null;if(s.names_renderer){u=s.names_renderer(q);}else u=q.map(function(x){return x.name;});var v=null;if(u.length==1){v=u[0];}else if(u.length==2){var w={participant1:u[0],participant2:u[1]};if(s.last_separator_uses_and){v=l._("{participant1} and {participant2}",w);}else v=l._("{participant1}, {participant2}",w);}else if(s.last_separator_uses_and){if(s.abbr_mode){v=l._("{participant1} and {others_link}",{participant1:u[0],others_link:this.renderRawParticipantCount(p,{render_subset:true,count:r-1,as_link:s.link_mode})});}else if(u.length==3){v=l._("{participant1}, {participant2} and {participant3}",{participant1:u[0],participant2:u[1],participant3:u[2]});}else v=l._("{participant1}, {participant2} and {others_link}",{participant1:u[0],participant2:u[1],others_link:this.renderRawParticipantCount(p,{render_subset:true,count:r-2,as_link:s.link_mode})});}else if(u.length==3){v=l._("{participant1}, {participant2}, {participant3}",{participant1:u[0],participant2:u[1],participant3:u[2]});}else v=l._("{participant1}, {participant2}, {participant3}, {others_link}",{participant1:u[0],participant2:u[1],participant3:u[2],others_link:this.renderRawParticipantCount(p,{render_subset:true,count:r-3,as_link:s.link_mode})});if(Array.isArray(v))v=h.create('span',{},v);return v;},renderRawTitleWithUnreadCount:function(p,q){var r=p;if(q&&q>1)r=h.create('span',{},l._("{conversation_title} ({unread_count})",{conversation_title:p,unread_count:q}));return r;},renderRawParticipantCount:function(p,q){function r(u,v){return h.create('a',{className:'hoverlistLink',href:j('/ajax/messaging/profile_browser/profile_browser.php').setQueryData(u),rel:'dialog'},v);}var s=q.render_subset,t;if(!s){t=q.count>1?l._("{num} people",{num:q.count}):"1 person";}else t=q.count>1?l._("{others_count} others",{others_count:q.count}):"1 other";if(q.as_link&&p){return r({tid:p},t);}else return t;},renderShortNames:function(p){if(p.length==1)return [p[0].name];return p.map(function(q){return q.short_name;});},renderUserCanonicalTitanLink:function(p,q,r){var s=new j().setSubdomain('www');s.setPath('/messages/'+p.substr(p.indexOf(':')+1));q.setAttribute('href',s.toString());r&&r();},renderTitanLinkWithServerID:function(p,q,r){var s=new j().setSubdomain('www');if(m.MessagesMercuryIntegrationGK){s.setPath(k.getURIPathForThreadID(p));}else{s.setPath('/messages/');s.setQueryData({action:'read',tid:p});}q.setAttribute('href',s.toString());r&&r();},renderStatusIndicator:function(p,q){var r=n.MercuryActionStatus,s;if(p==r.RESENDING){s=this.renderResendIndicator();}else if(p!==undefined&&p!=r.UNSENT&&p!=r.UNCONFIRMED&&p!=r.SUCCESS)s=this.renderErrorIndicator(p,q);return s;},renderResendIndicator:function(){return o[':fb:mercury:resend-indicator'].render();},renderErrorIndicator:function(p,q){var r=o[':fb:mercury:error-indicator'].render(),s;switch(p){case n.MercuryActionStatus.REQUEST_ERROR:case n.MercuryActionStatus.TRANSPORT_ERROR:case n.MercuryActionStatus.FAILED_UNKNOWN_REASON:case n.MercuryActionStatus.UNABLE_TO_CONFIRM:s="This message failed to send. Click to send again.";break;default:throw new Error('Invalid error code '+p);}i.set(r,s,'above','center');if(q){Event.listen(r,'click',q);g.addClass(r,'mercuryClickableErrorIndicator');}return r;},_cloneIfDOMElement:function(p){if(p.cloneNode){return p.cloneNode();}else return p;}};});
__d("MercuryMessages",["Arbiter","AsyncRequest","copyProperties","debounce","Env","JSLogger","KeyedCallbackManager","MercuryAssert","MercuryIDs","MercuryMessageIDs","MercuryParticipants","PresenceUtil","randomInt","RangedCallbackManager","MercuryServerDispatcher","MercuryServerRequests","MercuryThreadInformer","MercuryThreads","tx","MercuryConstants","MercuryConfig"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AsyncRequest'),i=b('copyProperties'),j=b('debounce'),k=b('Env'),l=b('JSLogger'),m=b('KeyedCallbackManager'),n=b('MercuryAssert'),o=b('MercuryIDs'),p=b('MercuryMessageIDs'),q=b('MercuryParticipants'),r=b('PresenceUtil'),s=b('randomInt'),t=b('RangedCallbackManager'),u=b('MercuryServerDispatcher'),v=b('MercuryServerRequests'),w=b('MercuryThreadInformer'),x=b('MercuryThreads'),y=b('tx'),z=c('MercuryConstants'),aa=c('MercuryConfig'),ba=z.MercuryGenericConstants,ca={},da={},ea={},fa={},ga={};function ha(za){var ab=za;if(fa[za])ab=fa[za];return ca[ab];}var ia={},ja={},ka=new m();function la(za){if(za.status===undefined)za.status=z.MercuryActionStatus.UNSENT;za.timestamp_absolute="Today";za.message_id=za.message_id||ra.generateNewClientMessageID(za.timestamp);var ab=q.user;za.specific_to_list=za.specific_to_list||[];if(za.specific_to_list.length&&za.specific_to_list.indexOf(ab)===-1)za.specific_to_list.push(ab);if(!za.thread_id){if(za.specific_to_list.length==1){za.thread_id='user:'+k.user;}else if(za.specific_to_list.length==2){var bb=za.specific_to_list[0]==ab?za.specific_to_list[1]:za.specific_to_list[0];if(o.tokenize(bb).type=='email'){za.thread_id=ba.PENDING_THREAD_ID;}else za.thread_id=x.getThreadIDForParticipant(bb);}za.thread_id=za.thread_id||'root:'+za.message_id;}if(!za.specific_to_list.length){var cb=v.tokenizeThreadID(za.thread_id);if(cb.type=='user')za.specific_to_list=['fbid:'+cb.value,ab];}}function ma(za,ab,bb){var cb=va(ab)?[z.MercuryMessageSourceTags.CHAT]:[],db=Date.now(),eb=Date.format(aa['24h_times']?'H:i':'g:ia',Math.floor(db/1000)),fb={action_type:za,thread_id:bb,author:q.user,author_email:null,coordinates:null,timestamp:db,timestamp_absolute:(new Date(db)).toLocaleDateString(),timestamp_relative:eb,is_unread:false,is_cleared:false,is_forward:false,spoof_warning:false,source:ab,source_tags:cb};return fb;}function na(za){switch(za){case z.MercuryPayloadSource.UNKNOWN:case z.MercuryPayloadSource.SERVER_INITIAL_DATA:case z.MercuryPayloadSource.SERVER_FETCH_THREAD_INFO:case z.MercuryPayloadSource.SERVER_THREAD_SYNC:return true;}return false;}function oa(za){return za&&za.substr(0,6)==='server';}function pa(za){if(!ia[za])ia[za]=new t(function(ab){return ha(ab).timestamp;},function(ab,bb){return bb-ab;});return ia[za];}g.subscribe(l.DUMP_EVENT,function(za,ab){var bb={};for(var cb in ca){var db=ca[cb],eb=db.thread_id;bb[eb]=bb[eb]||{};bb[eb][db.message_id]={action_type:db.action_type,author:db.author,is_unread:db.is_unread,timestamp:db.timestamp};}ab.messaging=ab.messaging||{};ab.messaging.local_message_ids=i({},fa);ab.messaging.messages=bb;});function qa(za,ab){za.forEach(function(bb){var cb=pa(bb);cb.setReachedEndOfArray();w.reorderedMessages(bb,ab);});}var ra={getMessagesFromIDs:function(za){return (za||[]).map(ha).filter(function(ab){return ab;});},hasLoadedNMessages:function(za,ab){var bb=pa(za);return bb.hasReachedEndOfArray()||bb.getCurrentArraySize()>=ab;},getThreadMessagesRangeImmediately:function(za,ab,bb,cb,db){return ra.getThreadMessagesRange(za,ab,bb,cb,u.IMMEDIATE,db);},getThreadMessagesRange:function(za,ab,bb,cb,db,eb){var fb=pa(za),gb=function(lb){cb(sa(lb));},hb=fb.executeOrEnqueue(ab,bb,gb),ib=fb.getUnavailableResources(hb),jb=ga[za];if(ib.length&&!jb){var kb=ja[za]||0;v.fetchThreadMessages(za,kb,ib.length,db,eb);}else ga[za]=false;return hb;},getThreadMessagesSinceTimestamp:function(za,ab){var bb=pa(za),cb=bb.getElementsUntil(ab);return sa(cb);},hasLoadedAllMessages:function(za){return pa(za).hasReachedEndOfArray();},unsubscribe:function(za,ab){n.isThreadID(ab);var bb=pa(ab);bb.unsubscribe(za);},addAttachmentData:function(za,ab,bb){var cb=ha(za);if(cb){var db=cb.attachments.indexOf(ab);if(db!=-1){cb.attachments[db]=bb;w.updatedMessage(cb.thread_id,cb.message_id,'attach');}}else{if(!da[za])da[za]=[];da[za].push({attach_key:ab,data:bb});}},handleUpdates:function(za,ab,bb){var cb={},db={},eb=z.MercuryActionStatus;for(var fb=0;fb<za.length;fb++){var gb=za[fb];if(gb.is_forward||bb==z.MercuryPayloadSource.SERVER_SEARCH){if(!ca[gb.message_id]){ca[gb.message_id]=gb;wa(gb);}continue;}var hb=gb.action_type;if(hb==z.MercuryActionType.SEND_MESSAGE){var ib=gb.client_message_id;if(ib&&fa[ib]&&gb.status){if(gb.status==eb.UNCONFIRMED){if(!db[gb.thread_id])db[gb.thread_id]=[];db[gb.thread_id].push(gb.client_message_id);}else if(!cb[gb.thread_id])cb[gb.thread_id]=[];var jb=ha(gb.client_message_id),kb=jb.status;jb.status=gb.status;if(gb.status==eb.SUCCESS){ra.updateLocalMessage(gb,bb);if(gb.client_thread_id==ba.PENDING_THREAD_ID){jb.thread_id=gb.thread_id;cb[gb.thread_id].push(jb.message_id);ka.setResource(jb.message_id,jb.thread_id);}}if(typeof kb!='undefined'||gb.status==eb.REQUEST_ERROR||gb.status==eb.TRANSPORT_ERROR||gb.status==eb.FAILED_UNKNOWN_REASON||gb.status==eb.UNABLE_TO_CONFIRM||gb.status==eb.SUCCESS)w.updatedMessage(gb.thread_id,ha(gb.client_message_id).message_id,bb);}continue;}else if(hb==z.MercuryActionType.DELETE_THREAD){pa(gb.thread_id).removeAllResources();continue;}else if(hb==z.MercuryActionType.DELETE_MESSAGES){var lb=gb.message_ids.map(function(tb){return ha(tb).message_id;}),mb=pa(gb.thread_id);mb.removeResources(lb);w.reorderedMessages(gb.thread_id,bb);continue;}else if(hb==z.MercuryActionType.LOG_MESSAGE){if(gb.log_message_type==z.MercuryLogMessageType.SERVER_ERROR)ga[gb.thread_id]=true;}else if(hb==z.MercuryActionType.CLEAR_CHAT){var nb=pa(gb.thread_id).getAllResources();nb.map(ha).forEach(function(tb){tb.is_cleared=true;});continue;}var ob=ha(gb.message_id);if((gb.threading_id&&fa[gb.threading_id])||(ob&&!ob.is_forward))continue;if(!cb[gb.thread_id])cb[gb.thread_id]=[];cb[gb.thread_id].push(gb.message_id);ca[gb.message_id]=gb;wa(gb);if(gb.threading_id&&gb.threading_id!=gb.message_id)p.addServerID(gb.threading_id,gb.message_id);if(!ab)w.receivedMessage(gb);}for(var pb in cb){var mb=pa(pb),qb=mb.getAllResources(),rb=qb.filter(function(tb){var ub=ca[tb];return ub.action_type==z.MercuryActionType.LOG_MESSAGE&&ub.log_message_type==z.MercuryLogMessageType.SERVER_ERROR;});mb.removeResources(rb);ta(pb,cb[pb]);if(ab){mb.addResources(cb[pb]);w.reorderedMessages(pb,bb);}else mb.addResourcesWithoutSorting(cb[pb].reverse(),0);w.updatedThread(pb);}var sb=Object.keys(db);if(sb.length)v.requestMessageConfirmation(db);},sendMessage:function(za,ab,bb){ab=ab||Function.prototype;la(za);fa[za.message_id]=za.message_id;if(za.thread_id=='root:'+za.message_id)pa(za.thread_id).setReachedEndOfArray();v.sendNewMessage(za,bb);if(za.thread_id==ba.PENDING_THREAD_ID){ca[za.message_id]=za;return ka.executeOrEnqueue(za.message_id,ab);}else ab(za.thread_id);},unsubscribeSend:function(za){ka.unsubscribe(za);},resendMessage:function(za,ab){var bb=i({},za);bb.status=z.MercuryActionStatus.RESENDING;bb.timestamp=(new Date()).getTime();bb.message_id=ra.generateNewClientMessageID(bb.timestamp);var cb=pa(za.thread_id);cb.removeResources([za.message_id]);ra.sendMessage(bb,null,ab);w.reorderedMessages(za.thread_id,z.MercuryPayloadSource.CLIENT_SEND_MESSAGE);},deleteMessages:function(za,ab){if(ab.length){var bb=pa(za),cb=bb.getCurrentArraySize()==ab.length&&bb.hasReachedEndOfArray();v.deleteMessages(za,ab,cb);}},updateLocalMessage:function(za,ab){var bb=za.message_id,cb=za.client_message_id;fa[cb]=bb;ca[bb]=ca[cb];p.addServerID(cb,bb);ca[cb]={};var db=ha(cb);if(za.timestamp)db.timestamp=za.timestamp;if(za.attachments&&za.attachments.length){db.raw_attachments=null;db.attachments=za.attachments;wa(db,bb);}},constructUserGeneratedMessageObject:function(za,ab,bb,cb){var db=ma(z.MercuryActionType.USER_GENERATED_MESSAGE,ab,bb);db.body=za;db.has_attachment=false;db.html_body=false;db.attachments=[];db.specific_to_list=cb||[];return db;},constructLogMessageObject:function(za,ab,bb,cb){var db=ma(z.MercuryActionType.LOG_MESSAGE,za,ab);db.log_message_type=bb;db.log_message_data=cb;return db;},generateNewClientMessageID:function(za){var ab=za+':'+(s(0,4294967295)+1)+'-'+r.getSessionID();return '<'+ab+'@mail.projektitan.com>';}};v.subscribe('update-messages',function(za,ab){var bb=(ab.actions||[]).filter(function(db){var eb=db.action_type;return (db.is_forward||db.thread_id)&&(eb==z.MercuryActionType.LOG_MESSAGE||eb==z.MercuryActionType.USER_GENERATED_MESSAGE||eb==z.MercuryActionType.SEND_MESSAGE||eb==z.MercuryActionType.CLEAR_CHAT||eb==z.MercuryActionType.DELETE_THREAD||eb==z.MercuryActionType.DELETE_MESSAGES);}),cb=na(ab.payload_source);if(oa(ab.payload_source))bb.forEach(function(db){if(!db.is_forward){var eb=x.getThreadMetaNow(db.thread_id);if(eb)db.is_cleared=db.timestamp<eb.chat_clear_time;}});ra.handleUpdates(bb,cb,ab.payload_source);if(ab.end_of_history)qa(ab.end_of_history,ab.payload_source);});function sa(za){var ab=za.map(ha);return ab.reverse();}function ta(za,ab){var bb=ab.filter(function(cb){return ua(ha(cb));});if(!ja[za])ja[za]=0;ja[za]+=bb.length;}function ua(za){var ab=za.action_type;if(ab==z.MercuryActionType.USER_GENERATED_MESSAGE)return true;switch(za.log_message_type){case z.MercuryLogMessageType.SUBSCRIBE:case z.MercuryLogMessageType.UNSUBSCRIBE:case z.MercuryLogMessageType.SERVER_ERROR:case z.MercuryLogMessageType.LIVE_LISTEN:return false;default:return true;}}function va(za){switch(za){case z.MercurySourceType.CHAT_WEB:case z.MercurySourceType.CHAT_JABBER:case z.MercurySourceType.CHAT_IPHONE:case z.MercurySourceType.CHAT_MEEBO:case z.MercurySourceType.CHAT_ORCA:case z.MercurySourceType.CHAT_TEST:case z.MercurySourceType.CHAT:case z.MercurySourceType.DESKTOP:return true;default:return false;}}function wa(za,ab){ab=ab||za.message_id;var bb=da[ab];if(bb){bb.forEach(function(cb){var db=za.attachments.indexOf(cb.attach_key);if(db!==-1)za.attachments[db]=cb.data;});delete da[ab];}else if(!za.is_forward&&xa(za)){ea[ab]=true;ya();}}function xa(za){if(!za||!za.attachments)return false;for(var ab=0;ab<za.attachments.length;ab++){var bb=za.attachments[ab];if(typeof bb==='string'&&bb.indexOf(z.MercuryAttachmentType.SHARE)===0)return true;}var cb=za.forward_message_ids||[];for(ab=0;ab<cb.length;ab++){var db=ha(cb[ab]);if(xa(db))return true;}return false;}var ya=j(function(){var za={};for(var ab in ea){var bb=ha(ab);if(xa(bb))za[ab]=true;}var cb=Object.keys(za);if(cb.length)new h('/ajax/mercury/attachments/fetch_shares.php').setData({message_ids:cb}).setAllowCrossPageTransition(true).send();ea={};},0,this,true);e.exports=ra;});
__d("MercuryRoger",["ArbiterMixin","MercuryServerRequests","copyProperties"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('MercuryServerRequests'),i=b('copyProperties'),j={},k={getSeenBy:function(l,m){if(!l)return [];var n=[],o=j[l.thread_id];for(var p in o)if(o[p]>l.timestamp&&(!m||p!=l.author))n.push(p);return n;},getSeenTimestamp:function(l,m){var n=j[l];return n?n[m]:null;}};i(k,g);h.subscribe('update-roger',function(l,m){for(var n in m){if(!j[n])j[n]={};for(var o in m[n]){var p=j[n][o],q=m[n][o];if(!p||q>p)j[n][o]=q;}}if(m)k.inform('state-changed',m);});e.exports=k;});
__d("MercuryDelayedRoger",["ArbiterMixin","copyProperties","LiveTimer","MercuryMessages","MercuryThreads","MercuryRoger","MercuryThreadInformer","setTimeoutAcrossTransitions","MercuryConfig","MercuryConstants"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('copyProperties'),i=b('LiveTimer'),j=b('MercuryMessages'),k=b('MercuryThreads'),l=b('MercuryRoger'),m=b('MercuryThreadInformer'),n=b('setTimeoutAcrossTransitions'),o=c('MercuryConfig'),p=c('MercuryConstants'),q={},r={},s=o['roger.seen_delay'],t=h({getSeenBy:function(x,y){if(r[x])return [];if(!q[x]){var z=k.getThreadMetaNow(x);if(z)q[x]={thread_id:x,author:z.participants[0],timestamp:z.timestamp};}return l.getSeenBy(q[x],y);}},g);function u(x){var y=false;j.getThreadMessagesRange(x,0,1,function(z){var aa=z[0];if(!aa)return;var ba=aa.timestamp,ca=p.MercuryActionStatus.SUCCESS;if(aa.action_id||aa.status==ca)ba-=i.getServerTimeOffset();var da=t.getSeenBy(x);if(r[x]){clearTimeout(r[x]);delete r[x];}var ea=ba+s,fa=ea-Date.now();if(fa>0)r[x]=n(function(){delete r[x];v(x);},fa);q[x]=aa;var ga=t.getSeenBy(x);if(da.length||ga.length)y=true;});return y;}function v(x){var y={};y[x]=true;t.inform('state-changed',y);}function w(event,x){var y={};for(var z in x)if(u(z))y[z]=true;for(var aa in y){t.inform('state-changed',y);break;}}l.subscribe('state-changed',function(x,y){for(var z in y)!r[z]&&v(z);});m.subscribe('messages-received',w);m.subscribe('messages-reordered',w);m.subscribe('messages-updated',w);e.exports=t;});
__d("MercurySeenByAll",["CSS","DataStore","DOM","MercuryParticipants","MercuryDelayedRoger","MercuryThreads"],function(a,b,c,d,e,f){var g=b('CSS'),h=b('DataStore'),i=b('DOM'),j=b('MercuryParticipants'),k=b('MercuryDelayedRoger'),l=b('MercuryThreads'),m={},n={updateOnSeenChange:function(p,q){m[p.tagName]=true;h.set(p,'thread-id',q.thread_id);g.addClass(p,'seenByListener');o(p,q);}};function o(p,q){var r=q.participants.filter(function(t){return t!==j.user;}),s=q.participants.length>0&&q.participants[0]===j.user;g.conditionClass(p,'repliedLast',s);g.conditionClass(p,'seenByAll',s&&k.getSeenBy(q.thread_id).length===r.length);}k.subscribe('state-changed',function(p,q){for(var r in m){var s=i.scry(document.body,r+'.seenByListener');for(var t=0;t<s.length;t++){var u=s[t],v=h.get(u,'thread-id');if(q[v])l.getThreadMeta(v,function(w){o(u,w);});}}});e.exports=n;});
__d("MercuryThreadMetadataRenderer",["event-extensions","CSS","DOM","HTML","JSLogger","MercuryAttachment","MercuryEmoji","MercuryThreadMetadataRawRenderer","MercuryParticipants","MercurySeenByAll","MercuryServerRequests","MercuryThreads","Tooltip","URI","cx","createArrayFrom","tx","MercuryImageTemplates","MercuryThreadlistIconTemplates","MercuryConstants","MercuryConfig"],function(a,b,c,d,e,f){b('event-extensions');var g=b('CSS'),h=b('DOM'),i=b('HTML'),j=b('JSLogger'),k=b('MercuryAttachment'),l=b('MercuryEmoji'),m=b('MercuryThreadMetadataRawRenderer'),n=b('MercuryParticipants'),o=b('MercurySeenByAll'),p=b('MercuryServerRequests'),q=b('MercuryThreads'),r=b('Tooltip'),s=b('URI'),t=b('cx'),u=c('MercuryImageTemplates'),v=c('MercuryThreadlistIconTemplates'),w=c('MercuryConstants'),x=c('MercuryConfig'),y=b('createArrayFrom'),z=b('tx'),aa=j.create('wm_timestamp');e.exports={renderTimestamp:function(da,ea,fa,ga){if(ga){if(!ea){aa.warn('no_title');ea=(new Date(ga)).toLocaleDateString();}da.setAttribute('title',ea);if(!fa){aa.warn('no_display');fa=Date.format(x['24h_times']?'H:i':'g:ia',Math.floor(ga/1000));}h.setContent(da,fa);g.show(da);}},renderMessageSourceTags:function(da,ea,fa,ga){var ha=w.MercuryMessageSourceTags,ia='',ja='',ka='';if(fa.contains(ha.MESSENGER)){ia="Sent from Messenger";ja=new s('/mobile/messenger');ka="-cx-PRIVATE-webMessengerMessageGroup__sourceMessenger";}else if(fa.contains(ha.CHAT)){ia="Sent from chat";ka="-cx-PRIVATE-webMessengerMessageGroup__sourceChat";}else if(fa.contains(ha.EMAIL)){if(ga){ia=z._("Sent from {email}",{email:ga});}else ia="Sent from email";ka="-cx-PRIVATE-webMessengerMessageGroup__sourceEmail";}else if(fa.contains(ha.MOBILE)){ia="Sent from Mobile";ja=new s('/mobile/');ka="-cx-PRIVATE-webMessengerMessageGroup__sourceMobile";}if(ka){r.set(da,ia);g.addClass(ea,ka);if(ja){da.setAttribute('href',ja);}else da.removeAttribute('href');}else g.hide(da);},renderMessageLocation:function(da,ea,fa){var ga=s('/ajax/messaging/hovercard/map.php').setQueryData(fa);da.setAttribute('data-hovercard',ga);g.removeClass(da,"-cx-PRIVATE-webMessengerMessageGroup__noLocation");g.show(ea);},renderSpoofWarning:function(da,ea,fa){if(ea){g.addClass(da,"-cx-PRIVATE-webMessengerMessageGroup__spoofWarning");r.set(da,z._("Unable to confirm {name_or_email} as the sender.",{name_or_email:fa.name}));}},renderCoreThreadlist:function(da,ea,fa,ga,ha){ga=ga||{};this.renderThreadImage(da,ea.getNode('image'));ca(da,ea.getNode('name'),ga);if(da.folder&&ha)ba(ea.getNode('folderBadge'),da.folder);var ia=ea.getNode('timestamp');this.renderTimestamp(ia,da.timestamp_absolute,da.timestamp_relative,da.timestamp);this.renderSnippet(da,ea.getNode('snippet'));fa(ea,da);},renderAndSeparatedParticipantList:function(da,ea,fa){fa=fa||{};fa.last_separator_uses_and=true;q.getThreadMeta(da,function(ga){ca(ga,ea,fa);}.bind(this));},renderSnippet:function(da,ea){var fa=h.create('span');g.addClass(fa,'MercuryRepliedIndicator');h.appendContent(ea,fa);o.updateOnSeenChange(fa,da);if(da.snippet_has_attachment)if(!da.snippet&&da.snippet_attachments){da.snippet_attachments.forEach(function(ia){if(ia.attach_type!=w.MercuryAttachmentType.FILE)return;var ja=k.getAttachIconClass(ia.icon_type),ka=v[':fb:mercury:attachment-icon-text'].build().getRoot();h.appendContent(ka,ia.name);g.addClass(ka,ja);h.appendContent(ea,ka);}.bind(this));}else h.appendContent(ea,h.create('span',{className:'MercuryAttachmentIndicator'}));if(da.is_forwarded_snippet){var ga;if(da.snippet){ga="Forwarded Message:";}else ga="Forwarded Message";h.appendContent(ea,h.create('strong',{className:'mercuryForwardedIndicator'},ga));}var ha=da.snippet;if(ha)if(ha.substr(0,4)=='?OTR'){ha="[encrypted message]";}else ha=ha.replace(/\r\n|[\r\n]/g," ");h.appendContent(ea,i(l.htmlEmojiAndEmote(ha)));},renderTitanLink:function(da,ea,fa){if(da.substr(0,da.indexOf(':'))=='user'){m.renderUserCanonicalTitanLink(da,ea,fa);}else p.getServerThreadID(da,function(ga){m.renderTitanLinkWithServerID(ga,ea,fa);});},renderThreadImage:function(da,ea){if(da.image_src){this._renderThreadImageSingle(da.image_src,ea);return;}var fa=[],ga=da.participants.filter(function(ha){return ha!=n.user;});if(!ga.length){fa=[n.user];}else if(ga.length==1){fa=[ga[0]];}else{fa=ga.slice(0,3);if(fa.length==2)fa.push(n.user);}n.getMulti(fa,function(ha){var ia=fa.map(function(ja){return ha[ja];});this.renderParticipantImages(ia,ea);}.bind(this));},renderParticipantImages:function(da,ea){if(da.length>2){this._renderThreadImageSplit(da,ea);}else this._renderThreadImageSingle(da[0].image_src,ea);},renderParticipantList:function(da,ea,fa,ga){return m.renderRawParticipantList(p.getServerThreadIDNow(da),ea,fa,ga);},renderThreadNameAndParticipantList:function(da,ea,fa,ga){var ha=m.renderRawParticipantList(p.getServerThreadIDNow(da),ea,fa,ga),ia=q.getThreadMetaNow(da);if(!ia.name)return ha;return z._("{conversation_name} [with {participant_list}]",{conversation_name:ia.name,participant_list:ha});},renderParticipantCount:function(da,ea){return m.renderRawParticipantCount(p.getServerThreadIDNow(da),ea);},_renderThreadImageSingle:function(da,ea){var fa=u[':fb:mercury:thread-image:single'].build().getRoot();fa.src=da;h.setContent(ea,fa);},_renderThreadImageSplit:function(da,ea){var fa=u[':fb:mercury:thread-image:split'].build().setNodeProperty('left','src',da[0].image_src).setNodeProperty('topRight','src',da[1].image_src).setNodeProperty('bottomRight','src',da[2].image_src);h.setContent(ea,fa.getRoot());}};function ba(da,ea){y(da).forEach(function(fa){h.setContent(fa,ea);});}function ca(da,ea,fa){ea=y(ea);if(da.name){var ga=m.renderRawTitleWithUnreadCount(da.name,fa.show_unread_count?da.unread_count:0);ea.forEach(function(ia){h.setContent(ia,ga);});fa.callback&&fa.callback(ga);return;}var ha=da.participants;if(da.participants.length>1)ha=da.participants.filter(function(ia){return ia!=n.user;});n.getMulti(ha,function(ia){m.renderParticipantListWithNoThreadName(p.getServerThreadIDNow(da.thread_id),da,ha,ia,ea,fa);}.bind(this));}});
__d("WebMessengerStateConstants",[],function(a,b,c,d,e,f){var g={STATE_CHANGE_EVENT:'state-changed',DETAIL:{COMPOSE_MAIN:'compose-main',COMPOSE_TYPEAHEAD_RESULTS:'compose-typeahead-results',COMPOSE_ALL_PEOPLE_RESULTS:'compose-all-people-results',RECENT_MESSAGES:'recent-messages',SEARCH_CONTEXT:'search-context',SEARCH_SNIPPET:'search-snippet'},MASTER:{RECENT_THREADS:'recent-threads',SEARCH:'search'},MESSAGE_ACTION:{DELETE:'delete',FORWARD:'forward'}};e.exports=g;});
__d("WebMessengerOldToNewPermalink",["WebMessengerPermalinkConstants","WebMessengerStateConstants"],function(a,b,c,d,e,f){var g=b('WebMessengerPermalinkConstants'),h=b('WebMessengerStateConstants');function i(n){if(!j(n))return n;k(n);m(n);l(n);return n;}function j(n){var o=n.getQueryData();if(o.sk)switch(o.sk){case 'inbox':n.setPath(g.BASE_PATH);n.removeQueryData('sk');break;case 'other':n.setPath(g.OTHER_PATH);n.removeQueryData('sk');break;default:return false;}return true;}function k(n){var o=n.getQueryData();switch(o.action){case 'read':if(!o.tid){n.addQueryData({action:h.DETAIL.RECENT_MESSAGES});}else n.removeQueryData('action');break;}}function l(n){var o=n.getQueryData();if(o.tid){n.setPath(g.getURIPathForThreadID(o.tid,n.getPath()));n.removeQueryData('tid');}}function m(n){var o=n.getQueryData();if(!n.getPath().match(g.SEARCH_POSTFIX_PATH)&&o.action!=h.DETAIL.SEARCH_SNIPPET&&!o.mid){var p=o.query;if(o.query){var q=/\bis:(archived|spam)\b(.*)/,r=q.exec(o.query);if(r){switch(r[1]){case 'archived':n.setPath(g.ARCHIVED_PATH);break;case 'spam':n.setPath(g.SPAM_PATH);break;}var s=o.query.substr(0,o.query.length-r[0].length),t=r[2];p=(s.trim()+' '+t.trim()).trim();}}if(o.thread_query){n.setPath(n.getPath()+g.SEARCH_POSTFIX_PATH);n.setQueryData({query:o.thread_query});}else if(p){n.setPath(n.getPath()+g.SEARCH_POSTFIX_PATH);n.addQueryData({query:p});}else n.removeQueryData('query');}}e.exports=i;});
__d("WebMessengerStateStore",["MercuryAssert","PresenceState"],function(a,b,c,d,e,f){var g=b('MercuryAssert'),h=b('PresenceState'),i=null;function j(){var l=h.get();if(l&&l.wml)return l.wml;return {};}h.registerStateStorer(function(l){if(i)l.wml=i;i=null;});var k={getLastSeenThreadID:function(){var l=j();return l.thread_id||null;},getLastSeenFolder:function(){var l=j();return l.folder||null;},setLastSeen:function(l,m){m&&g.isThreadID(m);i={folder:l,thread_id:m||null};h.doSync();}};e.exports=k;});
__d("WebMessengerPermalinks",["goURI","MercuryIDs","MercuryParticipants","MercuryFilters","WebMessengerOldToNewPermalink","WebMessengerPermalinkConstants","MercuryServerRequests","WebMessengerStateConstants","WebMessengerStateStore","MercuryThreads","Token","URI","MercuryConstants","WebMessengerConstants"],function(a,b,c,d,e,f){var g=b('goURI'),h=b('MercuryIDs'),i=b('MercuryParticipants'),j=b('MercuryFilters'),k=b('WebMessengerOldToNewPermalink'),l=b('WebMessengerPermalinkConstants'),m=b('MercuryServerRequests'),n=b('WebMessengerStateConstants'),o=b('WebMessengerStateStore'),p=b('MercuryThreads'),q=b('Token'),r=b('URI'),s=c('MercuryConstants'),t=c('WebMessengerConstants'),u={getDefaultURI:function(){var ga=new r().setSubdomain('www');ga.setPath(l.BASE_PATH);return ga;},goNextURI:function(ga,ha,ia){if(da(ga,ha,ia)){var ja=u.getURI(ga,ha,ia);g(ja);return true;}return false;},getURI:function(ga,ha,ia){var ja=u.getDefaultURI();if(!ga||!ha||!ia)return ja;switch(ia.folder){case s.MessagingTag.OTHER:ja.setPath(l.OTHER_PATH);break;case s.MessagingTag.ACTION_ARCHIVED:ja.setPath(l.ARCHIVED_PATH);break;case s.MessagingTag.SPAM:ja.setPath(l.SPAM_PATH);break;}if(ia.filter&&(ia.filter!=j.ALL))ja.addQueryData({filter:ia.filter});var ka;switch(ga){case n.MASTER.SEARCH:ka=false;ja.setPath(ja.getPath()+l.SEARCH_POSTFIX_PATH);break;}switch(ha){case n.DETAIL.COMPOSE_MAIN:case n.DETAIL.COMPOSE_TYPEAHEAD_RESULTS:case n.DETAIL.COMPOSE_ALL_PEOPLE_RESULTS:ja.setPath(ja.getPath()+l.COMPOSE_POSTFIX_PATH);ka=false;break;case n.DETAIL.RECENT_MESSAGES:ka=!ia.thread_id;break;case n.DETAIL.SEARCH_CONTEXT:ka=false;break;default:ka=true;break;}if(ka)ja.addQueryData({action:ha});if(ia.thread_id){var la=p.getCanonicalUserInThread(ia.thread_id),ma=la&&i.getNow(i.getIDForUser(la));if(ma&&ma.type!==s.MercuryParticipantTypes.EVENT){var na=(ma&&ma.vanity)||la;ja.setPath(l.getURIPathForIDOrVanity(na,ja.getPath()));}else{var oa=m.getServerThreadIDNow(ia.thread_id),pa=oa?oa:ia.thread_id;ja.setPath(l.getURIPathForThreadID(pa,ja.getPath()));}}if(ia.query)ja.addQueryData({query:ia.query});if(ia.message_query)ja.addQueryData({mquery:ia.message_query});if(ia.message_id)ja.addQueryData({mid:ia.message_id});if(ia.reuse_composer)ja.addQueryData({rc:true});return ja;},processURI:function(ga){ga=k(ga);if(!u.isWebMessengerURI(ga))return false;var ha=ea(ga);if(!ha.master_state||!ha.detail_state)return fa(ga);var ia={data:{folder:ba(ga),filter:ca(ga)},redirect:false,master_state:ha.master_state,detail_state:ha.detail_state};if(ga.getQueryData().rc)ia.data.reuse_composer=true;ia=y(ga,ia);switch(ha.detail_state){case n.DETAIL.RECENT_MESSAGES:return aa(ga,ia);case n.DETAIL.COMPOSE_MAIN:return v(ga,ia);case n.DETAIL.SEARCH_SNIPPET:ia=z(ga,ia);return ia;case n.DETAIL.SEARCH_CONTEXT:ia=aa(ga,ia);ia=z(ga,ia);return x(ga,ia);}ia.redirect=true;return ia;},isWebMessengerURI:function(ga){return (/^(\/messages|\/webmessenger)/).test(ga.getPath());}};function v(ga,ha){var ia=ga.getQueryData().to;return w(ia,ha);}function w(ga,ha){if(ga){var ia=i.getNow(i.getIDForUser(ga));if(ia){var ja={uid:ga,text:ia.name,type:t.USER_TYPE};ha.data.new_tokens=[new q(ja)];}}ha.data.start=true;return ha;}function x(ga,ha){var ia=ga.getQueryData().mid;if(ia){ha.data.message_id=ia;}else ha.redirect=true;return ha;}function y(ga,ha){var ia=ga.getQueryData().query;ha.data.query=ia;return ha;}function z(ga,ha){var ia=ga.getQueryData().mquery;ha.data.message_query=ia;return ha;}function aa(ga,ha){var ia=l.getThreadIDFromURI(ga);if(ia){var ja=h.isValid(ia)?ia:m.getClientThreadIDNow(ia);if(ja){ha.data.thread_id=ja;}else ha.redirect=true;}else{var ka=l.getUserIDOrVanity(ga.getPath());if(ka){var la=i.getIDFromVanityOrFBID(ka),ma=la&&p.getCanonicalThreadToParticipant(la,null,s.MercuryAPIArgsSource&&s.MercuryAPIArgsSource.WEBMESSENGER);if(ma){if(ma.timestamp){ha.data.thread_id=ma.thread_id;}else{ha.detail_state=n.DETAIL.COMPOSE_MAIN;ha=w(i.getUserID(la),ha);}}else ha.redirect=true;}}return ha;}function ba(ga,ha){var ia=ga.getPath();if(ia.match('^'+l.ARCHIVED_PATH))return s.MessagingTag.ACTION_ARCHIVED;if(ia.match('^'+l.OTHER_PATH))return s.MessagingTag.OTHER;if(ia.match('^'+l.SPAM_PATH))return s.MessagingTag.SPAM;if(ha!==undefined)return ha;return s.MessagingTag.INBOX;}function ca(ga){return ga.getQueryData().filter||j.ALL;}function da(ga,ha,ia){if(ha===n.DETAIL.SEARCH_CONTEXT)return false;if(ia&&ia.no_uri===true){delete ia.no_uri;return false;}var ja=ha==n.DETAIL.COMPOSE_MAIN||ha==n.DETAIL.COMPOSE_TYPEAHEAD_RESULTS||ha==n.DETAIL.COMPOSE_ALL_PEOPLE_RESULTS;if(ja&&(!ia.start||ia.new_tokens))return false;if(!ga||!ha||!ia)return true;if(ia.bug_reporting_enabled)return false;return !ia.message_action;}function ea(ga){var ha={},ia=ga.getPath(),ja=ga.getQueryData(),ka=ia.match(l.BASE_PATH+'(/[^/]+)?'+l.SEARCH_POSTFIX_PATH+'(/[^/]+)?');ha.master_state=ka&&ja.query?n.MASTER.SEARCH:n.MASTER.RECENT_THREADS;if(ja.action){ha.detail_state=ja.action;return ha;}if(ia.match(l.BASE_PATH+'(/[^/]+)?'+l.COMPOSE_POSTFIX_PATH)){ha.detail_state=n.DETAIL.COMPOSE_MAIN;return ha;}if(ia.match(l.TID_POSTFIX_PARTIAL_PATH)||l.getUserIDOrVanity(ia)){if(ja.mid&&ja.mquery){ha.detail_state=n.DETAIL.SEARCH_CONTEXT;}else ha.detail_state=n.DETAIL.RECENT_MESSAGES;}else if(ja.mquery)ha.detail_state=n.DETAIL.SEARCH_SNIPPET;return ha;}function fa(ga){var ha=ba(ga,null)||o.getLastSeenFolder(),ia=o.getLastSeenThreadID(),ja={redirect:!!ia||!!ha,master_state:n.MASTER.RECENT_THREADS,detail_state:n.DETAIL.RECENT_MESSAGES,data:{folder:ha||s.MessagingTag.INBOX,filter:j.ALL,thread_id:ia}};return ja;}e.exports=u;});
__d("MercuryJewelThreadlistControl",["event-extensions","ArbiterMixin","CSS","DOM","MercuryOrderedThreadlist","Parent","MercuryThreadInformer","MercuryThreadMetadataRenderer","MercuryThreads","WebMessengerPermalinks","WebMessengerStateConstants","copyProperties","tx","MercuryConfig","MercuryConstants","MercuryJewelTemplates"],function(a,b,c,d,e,f){b('event-extensions');var g=b('ArbiterMixin'),h=b('CSS'),i=b('DOM'),j=b('MercuryOrderedThreadlist'),k=b('Parent'),l=b('MercuryThreadInformer'),m=b('MercuryThreadMetadataRenderer'),n=b('MercuryThreads'),o=b('WebMessengerPermalinks'),p=b('WebMessengerStateConstants'),q=b('copyProperties'),r=b('tx'),s=c('MercuryConfig'),t=c('MercuryConstants'),u=c('MercuryJewelTemplates');function v(w){this._rootElement=w;this._contentElement=i.find(this._rootElement,'.jewelContent');this._loadingElement=i.find(this._rootElement,'.jewelLoading');l.subscribe('threadlist-updated',this.render.bind(this));this.render();}q(v,{EVENT_THREADS_LOADED:'threads-loaded',EVENT_THREADS_RENDERED:'threads-rendered'});q(v.prototype,g);q(v.prototype,{render:function(){i.empty(this._contentElement);h.show(this._loadingElement);var w=i.create('div');i.appendContent(this._contentElement,w);j.getThreadlist(t.MercuryThreadlistConstants.RECENT_THREAD_OFFSET,t.MercuryThreadlistConstants.JEWEL_THREAD_COUNT,t.MessagingTag.INBOX,this.renderThreads.bind(this,w),true);},renderThreads:function(w,x){this.inform(v.EVENT_THREADS_LOADED);if(x.length){x.forEach(function(y){var z=u[':fb:mercury:jewel:threadlist-row'].build();n.getThreadMeta(y,function(aa){m.renderCoreThreadlist(aa,z,this.renderSingleThread.bind(this),{show_unread_count:true});}.bind(this));i.appendContent(w,z.getRoot());}.bind(this));}else i.setContent(this._rootElement,this.renderEmptyThreadlist());h.hide(this._loadingElement);this.inform(v.EVENT_THREADS_RENDERED);},renderSingleThread:function(w,x){if(x.unread_count>0)h.addClass(w.getRoot(),'jewelItemNew');if(s.MessagesMercuryIntegrationGK){w.getNode('link').setAttribute('href',o.getURI(p.MASTER.RECENT_THREADS,p.DETAIL.RECENT_MESSAGES,{thread_id:x.thread_id}).toString());}else m.renderTitanLink(x.thread_id,w.getNode('link'));Event.listen(w.getRoot(),'mouseover',function(event){var y=w.getRoot();if(!k.byClass(y,'notifNegativeBase'))h.addClass(y,'selected');});Event.listen(w.getRoot(),'mouseout',function(event){h.removeClass(w.getRoot(),'selected');});},renderEmptyThreadlist:function(){return i.create('li',{className:'empty'},"No messages");}});e.exports=v;});
__d("MercuryJewel",["MercuryChannelHandler","MercuryJewelCountControl","DOM","MercuryJewelThreadlistControl","MercuryServerRequests","userAction"],function(a,b,c,d,e,f){b('MercuryChannelHandler');var g=b('MercuryJewelCountControl'),h=b('DOM'),i=b('MercuryJewelThreadlistControl'),j=b('MercuryServerRequests'),k=b('userAction'),l=false;function m(q,r,s,t){j.handleUpdate(t);var u=new g(r,s),v=h.find(q,'#MercuryJewelThreadList');if(s.getRoot()&&s.isOpen()){n.call(this,v);}else s.subscribe('opened',n.bind(this,v));}e.exports=m;function n(q){this._ua=k('messages').uai('click','jewel');this._listenForLoad=this._listenForRender=true;if(!l){var r=new i(q);r.subscribe(i.EVENT_THREADS_LOADED,o.bind(this));r.subscribe(i.EVENT_THREADS_RENDERED,p.bind(this));l=true;}}function o(){if(this._listenForLoad){this._ua.add_event('loaded');this._listenForLoad=false;}}function p(){if(this._listenForRender){this._ua.add_event('rendered');this._listenForRender=false;}}});
__d("TitanLeftNav",["CounterDisplay","MessagingEvents"],function(a,b,c,d,e,f){var g=b('CounterDisplay'),h=b('MessagingEvents'),i={initialize:function(){h.subscribe('count/other_unseen',function(j,k){g.setCount('other_unseen',k);});}};e.exports=i;});
__d("LiveMessageReceiver",["Arbiter","AsyncRequest","ChannelConstants","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AsyncRequest'),i=b('ChannelConstants'),j=b('copyProperties');function k(l){this.eventName=l;this.subs=null;this.handler=bagofholding;this.shutdownHandler=null;this.registered=false;this.appId=1;}j(k,{getAppMessageType:function(l,m){return 'live_message/'+l+':'+m;},route:function(l){var m=function(n){var o=k.getAppMessageType(l.app_id,l.event_name);g.inform(o,n,g.BEHAVIOR_PERSISTENT);};if(l.hasCapture){new h().setHandler(function(n){m(n.getPayload());}).setAllowCrossPageTransition(true).handleResponse(l.response);}else m(l.response);}});j(k.prototype,{setAppId:function(l){this.appId=l;return this;},setHandler:function(l){this.handler=l;this._dirty();return this;},setRestartHandler:bagofholding,setShutdownHandler:function(l){this.shutdownHandler=l.shield();this._dirty();return this;},_dirty:function(){if(this.registered){this.unregister();this.register();}},register:function(){var l=function(n,o){return this.handler(o);}.bind(this),m=k.getAppMessageType(this.appId,this.eventName);this.subs={};this.subs.main=g.subscribe(m,l);if(this.shutdownHandler)this.subs.shut=g.subscribe(i.ON_SHUTDOWN,this.shutdownHandler);this.registered=true;return this;},unregister:function(){if(!this.subs)return this;for(var l in this.subs)if(this.subs[l])this.subs[l].unsubscribe();this.subs=null;this.registered=false;return this;}});e.exports=k;});
__d("legacy:livemessage",["LiveMessageReceiver"],function(a,b,c,d){a.LiveMessageReceiver=b('LiveMessageReceiver');},3);